<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NutriLab Health Store</title>

  <!-- Telegram WebApp (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#07161a;
      --card:#0b2730;
      --card2:#0a1f25;
      --text:#e7f7f6;
      --muted:#94b7b6;
      --accent:#2fe6b7;
      --accent2:#1fb08d;
      --danger:#ff5a6a;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 30% -20%, rgba(47,230,183,.22), transparent 55%),
                  radial-gradient(900px 700px at 100% 0%, rgba(31,176,141,.20), transparent 55%),
                  linear-gradient(180deg, #061318, #061216);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{
      max-width: 820px;
      margin: 0 auto;
      padding: 18px 16px 110px;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(47,230,183,.95), rgba(31,176,141,.55));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .brandtxt{min-width:0}
    .brandtxt .name{font-weight:800; letter-spacing:.2px; font-size:18px; line-height:1.05}
    .brandtxt .sub{color:var(--muted); font-size:12px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:700;
      display:flex; gap:8px; align-items:center;
    }
    .btn.accent{
      background: linear-gradient(135deg, rgba(47,230,183,.95), rgba(31,176,141,.75));
      color:#052016;
    }
    .btn:active{transform: translateY(1px)}

    .searchRow{
      display:flex; gap:10px; align-items:center;
      margin: 12px 0 14px;
    }
    .search{
      flex:1;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px 14px;
      color: var(--text);
      outline:none;
      font-size: 15px;
    }
    .chipRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .chip{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-weight:800;
      font-size: 13px;
    }
    .chip.active{
      background: rgba(47,230,183,.18);
      border-color: rgba(47,230,183,.35);
      color: #cffff3;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (min-width: 720px){
      .grid{grid-template-columns: repeat(3, minmax(0, 1fr));}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .img{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      border: 1px solid rgba(255,255,255,.08);
    }
    .img img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
    }
    .fav{
      position:absolute;
      top:10px; right:10px;
      width:38px; height:38px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: white;
      display:flex; align-items:center; justify-content:center;
      font-size: 18px;
      backdrop-filter: blur(8px);
    }
    .fav.on{ background: rgba(255,90,106,.18); border-color: rgba(255,90,106,.35); }
    .meta{margin-top:10px}
    .title{font-weight:900; font-size:14px; line-height:1.2; margin: 0 0 6px}
    .desc{color:var(--muted); font-size:12px; line-height:1.25; min-height: 30px}
    .row{display:flex; align-items:center; justify-content:space-between; margin-top:10px; gap:10px}
    .price{font-weight:1000; font-size:18px; letter-spacing:.2px}
    .small{color:var(--muted); font-size:12px}

    .cardBtns{display:flex; gap:8px; margin-top:10px}
    .cardBtns .btn2{
      flex:1;
      padding: 10px 10px;
      border-radius: 14px;
      border: none;
      font-weight:900;
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.10);
    }
    .cardBtns .btn2.buy{
      background: linear-gradient(135deg, rgba(47,230,183,.95), rgba(31,176,141,.75));
      color:#052016;
      border: none;
    }

    .panel{
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .panel h3{margin:0 0 8px; font-size: 16px}
    .panel p{margin:6px 0; color: var(--muted); font-size: 13px; line-height:1.35}

    .errorBox{
      margin: 12px 0;
      background: rgba(255,90,106,.12);
      border: 1px solid rgba(255,90,106,.30);
      color: #ffd7dc;
      padding: 12px;
      border-radius: 16px;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .okBox{
      margin: 12px 0;
      background: rgba(47,230,183,.10);
      border: 1px solid rgba(47,230,183,.28);
      color: #d7fff4;
      padding: 12px;
      border-radius: 16px;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(6,18,22,.92);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
    }
    .tabs{
      max-width: 820px;
      margin: 0 auto;
      display:flex; gap:10px;
    }
    .tab{
      flex:1;
      padding: 12px 10px;
      border-radius: 18px;
      text-align:center;
      font-weight:1000;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(47,230,183,.95), rgba(31,176,141,.75));
      color:#052016;
      border:none;
    }

    .hide{display:none !important}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandtxt">
          <div class="name">NutriLab Health</div>
          <div class="sub">Premium Supplements</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="sortBtn">‚áÖ</button>
        <button class="btn accent" id="orderBtn">‚úâÔ∏è –ó–∞–∫–∞–∑</button>
      </div>
    </div>

    <div class="searchRow">
      <input class="search" id="searchInput" placeholder="üîé  –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." />
    </div>

    <div class="chipRow" id="chips"></div>

    <div id="statusBox" class="hide"></div>

    <!-- Screens -->
    <div id="screenHome">
      <div class="grid" id="grid"></div>
    </div>

    <div id="screenFav" class="hide">
      <div class="panel">
        <h3>‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h3>
        <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –¥–æ–±–∞–≤–∏–ª(–∞) –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.</p>
      </div>
      <div style="height:12px"></div>
      <div class="grid" id="gridFav"></div>
    </div>

    <div id="screenCart" class="hide">
      <div class="panel">
        <h3>üõí –ö–æ—Ä–∑–∏–Ω–∞</h3>
        <p id="cartSummary"></p>
        <button class="btn accent" id="checkoutBtn">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å</button>
      </div>
      <div style="height:12px"></div>
      <div class="grid" id="gridCart"></div>
    </div>

    <div id="screenProfile" class="hide">
      <div class="panel">
        <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
        <p id="profileText">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
        <button class="btn" id="resetLocalBtn" style="margin-top:10px">–°–±—Ä–æ—Å–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ/–∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
    </div>
  </div>

  <div class="bottomNav">
    <div class="tabs">
      <button class="tab active" data-tab="home">üè† –ì–ª–∞–≤–Ω–∞—è</button>
      <button class="tab" data-tab="fav">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
      <button class="tab" data-tab="cart">üõí –ö–æ—Ä–∑–∏–Ω–∞</button>
      <button class="tab" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
    </div>
  </div>

<script>
  // ==== 1) Supabase config (—Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç) ====
  const SUPABASE_URL = "https://cthfqhxnplyibdsjzcrq.supabase.co";
  const SUPABASE_KEY = "sb_publishable_AjGX1zKhV8kEyGMbvAKwQg_srda-oyI";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ==== 2) Storage helpers ====
  const LS_FAV = "nl_fav_ids";
  const LS_CART = "nl_cart"; // {id: qty}

  function loadFav(){
    try { return new Set(JSON.parse(localStorage.getItem(LS_FAV) || "[]")); }
    catch { return new Set(); }
  }
  function saveFav(set){
    localStorage.setItem(LS_FAV, JSON.stringify([...set]));
  }

  function loadCart(){
    try { return JSON.parse(localStorage.getItem(LS_CART) || "{}"); }
    catch { return {}; }
  }
  function saveCart(obj){
    localStorage.setItem(LS_CART, JSON.stringify(obj));
  }

  // ==== 3) State ====
  let products = [];
  let filtered = [];
  let favSet = loadFav();
  let cart = loadCart();
  let activeCategory = "–í—Å–µ";
  let sortMode = "default"; // default | priceAsc | priceDesc

  const elGrid = document.getElementById("grid");
  const elGridFav = document.getElementById("gridFav");
  const elGridCart = document.getElementById("gridCart");
  const elChips = document.getElementById("chips");
  const elSearch = document.getElementById("searchInput");
  const elStatus = document.getElementById("statusBox");
  const elCartSummary = document.getElementById("cartSummary");

  // ==== 4) UI helpers ====
  function showStatus(type, text){
    elStatus.className = "";
    elStatus.classList.add(type === "error" ? "errorBox" : "okBox");
    elStatus.textContent = text;
  }
  function hideStatus(){
    elStatus.className = "hide";
    elStatus.textContent = "";
  }

  function money(v){
    if (v === null || v === undefined || v === "") return "";
    const n = Number(v);
    if (!Number.isFinite(n)) return String(v);
    return n.toLocaleString("ru-RU") + " ‚ÇΩ";
  }

  function safeText(x){ return (x ?? "").toString(); }

  function productCard(p){
    const id = p.id;
    const isFav = favSet.has(id);
    const img = p.image_url ? safeText(p.image_url) : "https://via.placeholder.com/600x600?text=NutriLab";
    const desc = safeText(p.description || "");
    const price = p.price;

    return `
      <div class="card" data-id="${id}">
        <div style="position:relative">
          <div class="img">
            <img src="${img}" alt="${safeText(p.name)}" onerror="this.src='https://via.placeholder.com/600x600?text=No+Image'">
          </div>
          <button class="fav ${isFav ? "on" : ""}" data-action="toggleFav" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">${isFav ? "‚ù§Ô∏è" : "ü§ç"}</button>
        </div>

        <div class="meta">
          <div class="title">${safeText(p.name)}</div>
          <div class="desc">${desc ? desc : "<span class='small'>–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</span>"}</div>

          <div class="row">
            <div class="price">${money(price)}</div>
            <div class="small">id: ${id}</div>
          </div>

          <div class="cardBtns">
            <button class="btn2" data-action="addCart">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button>
            <button class="btn2 buy" data-action="buyNow">‚úÖ –ö—É–ø–∏—Ç—å</button>
          </div>
        </div>
      </div>
    `;
  }

  function renderGrid(){
    elGrid.innerHTML = filtered.map(productCard).join("") || `
      <div class="panel" style="grid-column:1/-1">
        <h3>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
        <p>–ù–µ –Ω–∞—à–ª–∏ —Ç–æ–≤–∞—Ä—ã –ø–æ —Ñ–∏–ª—å—Ç—Ä—É/–ø–æ–∏—Å–∫—É. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω—è—Ç—å —Ñ–∏–ª—å—Ç—Ä –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ Supabase.</p>
      </div>
    `;
  }

  function renderFav(){
    const favProducts = products.filter(p => favSet.has(p.id));
    elGridFav.innerHTML = favProducts.map(productCard).join("") || `
      <div class="panel" style="grid-column:1/-1">
        <h3>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
        <p>–ù–∞–∂–º–∏ ‚ù§Ô∏è –Ω–∞ —Ç–æ–≤–∞—Ä–µ, –∏ –æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.</p>
      </div>
    `;
  }

  function renderCart(){
    const ids = Object.keys(cart).map(Number);
    const cartProducts = products.filter(p => ids.includes(p.id));

    let total = 0;
    for (const p of cartProducts){
      const qty = cart[p.id] || 0;
      const price = Number(p.price) || 0;
      total += price * qty;
    }

    elCartSummary.textContent = ids.length
      ? `–¢–æ–≤–∞—Ä–æ–≤: ${ids.length} ‚Ä¢ –°—É–º–º–∞: ${money(total)}`
      : "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è. –î–æ–±–∞–≤—å —Ç–æ–≤–∞—Ä—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π.";

    elGridCart.innerHTML = cartProducts.map(p => {
      const qty = cart[p.id] || 1;
      return `
        <div class="card" data-id="${p.id}">
          <div class="title">${safeText(p.name)}</div>
          <div class="row">
            <div class="price">${money(p.price)}</div>
            <div class="small">x ${qty}</div>
          </div>
          <div class="cardBtns">
            <button class="btn2" data-action="decQty">‚ûñ</button>
            <button class="btn2" data-action="incQty">‚ûï</button>
            <button class="btn2" data-action="removeCart">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join("") || `
      <div class="panel" style="grid-column:1/-1">
        <h3>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è</h3>
        <p>–ù–∞–∂–º–∏ ‚Äú–í –∫–æ—Ä–∑–∏–Ω—É‚Äù –Ω–∞ —Ç–æ–≤–∞—Ä–µ.</p>
      </div>
    `;
  }

  function renderChips(){
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–µ—Ä—ë–º –∏–∑ –ø–æ–ª—è category, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ "–í—Å–µ"
    const cats = new Set(["–í—Å–µ"]);
    for (const p of products){
      if (p.category) cats.add(String(p.category));
    }

    elChips.innerHTML = [...cats].map(c => `
      <button class="chip ${c === activeCategory ? "active": ""}" data-action="setCategory" data-cat="${c}">
        ${c}
      </button>
    `).join("");
  }

  function applyFilters(){
    const q = elSearch.value.trim().toLowerCase();

    filtered = products.filter(p => {
      const matchCat = (activeCategory === "–í—Å–µ") ? true : String(p.category || "") === activeCategory;
      const text = (safeText(p.name) + " " + safeText(p.description)).toLowerCase();
      const matchSearch = q ? text.includes(q) : true;
      return matchCat && matchSearch;
    });

    if (sortMode === "priceAsc") filtered.sort((a,b) => (Number(a.price)||0) - (Number(b.price)||0));
    if (sortMode === "priceDesc") filtered.sort((a,b) => (Number(b.price)||0) - (Number(a.price)||0));

    renderGrid();
  }

  // ==== 5) Telegram init ====
  function initTelegram(){
    try{
      const tg = window.Telegram?.WebApp;
      if (tg){
        tg.ready();
        tg.expand();
      }
    }catch(e){}
  }

  function renderProfile(){
    const tg = window.Telegram?.WebApp;
    if (tg?.initDataUnsafe?.user){
      const u = tg.initDataUnsafe.user;
      const name = `${u.first_name || ""} ${u.last_name || ""}`.trim();
      document.getElementById("profileText").textContent =
        `–û—Ç–∫—Ä—ã—Ç–æ –≤ Telegram WebApp\n–ò–º—è: ${name || "-"}\nUsername: ${u.username || "-"}\nID: ${u.id || "-"}`;
    } else {
      document.getElementById("profileText").textContent =
        "–û—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (Safari/Chrome).\nTelegram user –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ç—ã –Ω–µ –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞.";
    }
  }

  // ==== 6) Supabase load ====
  async function loadProducts(){
    hideStatus();

    try{
      const { data, error } = await supabase
        .from("products")
        .select("id,name,price,description,image_url,category")
        .order("id", { ascending: true });

      if (error) throw error;

      products = (data || []).map(x => ({
        id: x.id,
        name: x.name,
        price: x.price,
        description: x.description,
        image_url: x.image_url,
        category: x.category
      }));

      if (!products.length){
        showStatus("ok", "–¢–æ–≤–∞—Ä—ã –∏–∑ Supabase –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –Ω–æ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è. –î–æ–±–∞–≤—å —Å—Ç—Ä–æ–∫–∏ –≤ public.products.");
      } else {
        hideStatus();
      }

      renderChips();
      applyFilters();
      renderFav();
      renderCart();

    } catch (e){
      // –û—á–µ–Ω—å –≤–∞–∂–Ω–æ: –ø–æ–∫–∞–∂–µ–º –æ—à–∏–±–∫—É –ø—Ä—è–º–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
      showStatus("error",
`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ Supabase.

–ü—Ä–∏—á–∏–Ω–∞:
${e?.message || e}

–ß–¢–û –î–ï–õ–ê–¢–¨:
1) –í Supabase –æ—Ç–∫—Ä–æ–π Table Editor ‚Üí products ‚Üí (–∫–Ω–æ–ø–∫–∞) Add RLS policy.
2) –õ–∏–±–æ –í–´–ö–õ–Æ–ß–ò RLS, –ª–∏–±–æ –¥–æ–±–∞–≤—å policy –Ω–∞ SELECT –¥–ª—è anon.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —Å–∫–∏–Ω—å —Å–∫—Ä–∏–Ω policy/RLS –∏ —è —Å–∫–∞–∂—É —á—Ç–æ –Ω–∞–∂–∞—Ç—å.`);
      products = [];
      filtered = [];
      renderChips();
      renderGrid();
      renderFav();
      renderCart();
    }
  }

  // ==== 7) Events (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–ª–∏) ====
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;

    const action = btn.dataset.action;
    const card = btn.closest("[data-id]");
    const id = card ? Number(card.dataset.id) : null;

    if (action === "toggleFav" && id){
      if (favSet.has(id)) favSet.delete(id); else favSet.add(id);
      saveFav(favSet);
      applyFilters();
      renderFav();
      return;
    }

    if (action === "addCart" && id){
      cart[id] = (cart[id] || 0) + 1;
      saveCart(cart);
      renderCart();
      return;
    }

    if (action === "buyNow" && id){
      cart[id] = (cart[id] || 0) + 1;
      saveCart(cart);
      renderCart();
      switchTab("cart");

      const tg = window.Telegram?.WebApp;
      tg?.HapticFeedback?.impactOccurred?.("medium");
      return;
    }

    if (action === "incQty" && id){
      cart[id] = (cart[id] || 0) + 1;
      saveCart(cart);
      renderCart();
      return;
    }
    if (action === "decQty" && id){
      cart[id] = Math.max(1, (cart[id] || 1) - 1);
      saveCart(cart);
      renderCart();
      return;
    }
    if (action === "removeCart" && id){
      delete cart[id];
      saveCart(cart);
      renderCart();
      return;
    }

    if (action === "setCategory"){
      activeCategory = btn.dataset.cat || "–í—Å–µ";
      renderChips();
      applyFilters();
      return;
    }
  });

  elSearch.addEventListener("input", () => applyFilters());

  document.getElementById("sortBtn").addEventListener("click", () => {
    // –∫—Ä—É–≥–æ–≤–∞—è —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    sortMode = (sortMode === "default") ? "priceAsc" : (sortMode === "priceAsc" ? "priceDesc" : "default");
    const txt = sortMode === "default" ? "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
              : sortMode === "priceAsc" ? "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Ü–µ–Ω–∞ ‚Üë"
              : "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Ü–µ–Ω–∞ ‚Üì";
    showStatus("ok", txt);
    setTimeout(hideStatus, 1200);
    applyFilters();
  });

  document.getElementById("orderBtn").addEventListener("click", () => {
    switchTab("cart");
  });

  document.getElementById("checkoutBtn").addEventListener("click", () => {
    const ids = Object.keys(cart);
    if (!ids.length){
      showStatus("error", "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è ‚Äî –¥–æ–±–∞–≤—å —Ç–æ–≤–∞—Ä—ã –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.");
      return;
    }

    // –ü—Ä–æ—Å—Ç–∞—è "–∑–∞—è–≤–∫–∞" ‚Äî –≤ Telegram –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É —á–µ—Ä–µ–∑ tg.sendData
    const order = ids.map(id => ({ id: Number(id), qty: cart[id] }));
    const payload = JSON.stringify({ order, ts: Date.now() });

    const tg = window.Telegram?.WebApp;
    if (tg?.sendData){
      tg.sendData(payload);
      showStatus("ok", "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –±–æ—Ç–∞ ‚úÖ");
    } else {
      showStatus("ok", "–û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram. –í–æ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞:\n" + payload);
    }
  });

  document.getElementById("resetLocalBtn").addEventListener("click", () => {
    localStorage.removeItem(LS_FAV);
    localStorage.removeItem(LS_CART);
    favSet = loadFav();
    cart = loadCart();
    applyFilters();
    renderFav();
    renderCart();
    showStatus("ok", "–°–±—Ä–æ—à–µ–Ω–æ ‚úÖ");
    setTimeout(hideStatus, 1200);
  });

  // Tabs
  function switchTab(tab){
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === tab));
    document.getElementById("screenHome").classList.toggle("hide", tab !== "home");
    document.getElementById("screenFav").classList.toggle("hide", tab !== "fav");
    document.getElementById("screenCart").classList.toggle("hide", tab !== "cart");
    document.getElementById("screenProfile").classList.toggle("hide", tab !== "profile");

    if (tab === "fav") renderFav();
    if (tab === "cart") renderCart();
    if (tab === "profile") renderProfile();
  }
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => switchTab(btn.dataset.tab));
  });

  // ==== init ====
  (async function init(){
    initTelegram();
    renderProfile();
    await loadProducts();
  })();
</script>
</body>
</html>
