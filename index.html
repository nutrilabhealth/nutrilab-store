<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NutriLab Store</title>

  <!-- Supabase (–í–ê–ñ–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω jsdelivr!) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Telegram WebApp (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg1:#071018;
      --bg2:#03151e;
      --card:#0b2230;
      --card2:#0d2a3a;
      --text:#eaf6ff;
      --muted:#9fc0d3;
      --accent:#2ee59d;
      --accent2:#1cc7ff;
      --danger:#ff5d5d;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 30% 0%, rgba(46,229,157,.12), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(28,199,255,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding-bottom: 92px; /* –º–µ—Å—Ç–æ –ø–æ–¥ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 14px 14px 12px 14px;
      backdrop-filter: blur(10px);
      background: rgba(2,12,18,.55);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .brandRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(46,229,157,.9), rgba(28,199,255,.75));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .brandTitle{
      line-height:1.05;
      font-weight:800;
      font-size:16px;
      letter-spacing:.2px;
    }
    .brandSub{
      margin-top:3px;
      color:var(--muted);
      font-size:12px;
      font-weight:600;
      opacity:.9;
    }
    .topActions{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .search input{
      width:100%;
      background:transparent;
      border:0;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    .pillBtn{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(46,229,157,.12);
      border: 1px solid rgba(46,229,157,.22);
      color: var(--text);
      font-weight:700;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .pillBtn:active{transform: translateY(1px)}
    .tabs{
      display:flex;
      gap:8px;
      margin-top:12px;
      overflow:auto;
      padding-bottom:2px;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tabChip{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .tabChip.active{
      color:#052018;
      background: linear-gradient(135deg, rgba(46,229,157,.95), rgba(28,199,255,.75));
      border-color: transparent;
    }

    .container{
      padding: 14px;
      max-width: 980px;
      margin: 0 auto;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 14px;
    }
    @media (min-width: 720px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .imgBox{
      height: 150px;
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .imgBox img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .favBtn{
      position:absolute;
      top:10px;
      right:10px;
      width:40px;height:40px;border-radius:14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-size:18px;
      backdrop-filter: blur(8px);
    }
    .favBtn.active{
      background: rgba(255,60,120,.22);
      border-color: rgba(255,60,120,.35);
    }

    .cardBody{
      padding: 12px 12px 12px 12px;
    }
    .title{
      font-weight:900;
      font-size:14px;
      margin:0 0 6px 0;
      letter-spacing:.2px;
    }
    .desc{
      margin:0 0 10px 0;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
      min-height: 32px;
      opacity:.95;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .price{
      font-weight:1000;
      font-size:16px;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .btnRow{
      display:flex;
      gap:8px;
      margin-top: 10px;
    }
    .btn{
      flex:1;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .btn.primary{
      background: rgba(46,229,157,.18);
      border-color: rgba(46,229,157,.26);
    }
    .btn:active{transform: translateY(1px)}

    .empty{
      margin: 22px 0 0 0;
      padding: 16px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.09);
      color: var(--muted);
    }

    /* –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
    .bottomNav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px 14px 12px;
      background: rgba(2,12,18,.72);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      z-index: 60;
    }
    .navRow{
      max-width: 980px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .navBtn{
      padding: 12px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-weight: 900;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .navBtn.active{
      color:#052018;
      background: linear-gradient(135deg, rgba(46,229,157,.95), rgba(28,199,255,.75));
      border-color: transparent;
    }

    /* Debug */
    #__debug{
      position: fixed;
      left: 12px; right: 12px; bottom: 110px;
      z-index: 999999;
      display:none;
      background: rgba(0,0,0,.85);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font: 12px/1.35 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
      max-height: 40vh;
      overflow:auto;
      white-space: pre-wrap;
    }
    #__debug b{display:block;margin-bottom:6px}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brandRow">
      <div class="logo"></div>
      <div>
        <div class="brandTitle">NutriLab Health</div>
        <div class="brandSub">Premium Supplements</div>
      </div>
    </div>

    <div class="topActions">
      <div class="search">
        <span>üîé</span>
        <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." />
      </div>
      <div class="pillBtn" id="orderBtn">‚úâÔ∏è –ó–∞–∫–∞–∑</div>
    </div>

    <div class="tabs" id="categoryTabs"></div>
  </div>

  <div class="container">
    <div id="screen-home" class="screen">
      <div id="productsGrid" class="grid"></div>
      <div id="homeEmpty" class="empty" style="display:none;"></div>
    </div>

    <div id="screen-fav" class="screen" style="display:none;">
      <h3 style="margin:10px 0 6px 0;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h3>
      <div id="favGrid" class="grid"></div>
      <div id="favEmpty" class="empty" style="display:none;"></div>
    </div>

    <div id="screen-cart" class="screen" style="display:none;">
      <h3 style="margin:10px 0 6px 0;">–ö–æ—Ä–∑–∏–Ω–∞</h3>
      <div id="cartList"></div>
      <div id="cartEmpty" class="empty" style="display:none;"></div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
        <div style="flex:1;font-weight:1000;">–ò—Ç–æ–≥–æ: <span id="cartTotal">0</span> ‚ÇΩ</div>
        <div class="btn primary" id="checkoutBtn" style="flex:1;">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å</div>
      </div>
    </div>

    <div id="screen-profile" class="screen" style="display:none;">
      <h3 style="margin:10px 0 6px 0;">–ü—Ä–æ—Ñ–∏–ª—å</h3>
      <div class="empty">
        <div style="font-weight:900;margin-bottom:6px;">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        <div id="profileText" style="color:var(--muted)"></div>
      </div>

      <div class="empty" style="margin-top:12px;">
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <div class="btn" id="clearFavBtn">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
          <div class="btn" id="clearCartBtn">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</div>
          <div class="btn" id="reloadBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã</div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottomNav">
    <div class="navRow">
      <div class="navBtn active" data-screen="home">üè† –ì–ª–∞–≤–Ω–∞—è</div>
      <div class="navBtn" data-screen="fav">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
      <div class="navBtn" data-screen="cart">üõí –ö–æ—Ä–∑–∏–Ω–∞</div>
      <div class="navBtn" data-screen="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
  </div>

  <div id="__debug"><b>DEBUG</b><div id="__debug_text"></div></div>

<script>
  /***********************
   * 0) DEBUG (–æ—à–∏–±–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
   ***********************/
  function debug(msg){
    const box = document.getElementById('__debug');
    const text = document.getElementById('__debug_text');
    box.style.display = 'block';
    text.textContent += (text.textContent ? "\n\n" : "") + String(msg);
  }
  window.addEventListener('error', e => debug("JS error: " + (e.message || e.error)));
  window.addEventListener('unhandledrejection', e => debug("Promise error: " + (e.reason?.message || e.reason)));

  /***********************
   * 1) SUPABASE CONFIG (—Ç–≤–æ–π URL –∏ publishable key)
   ***********************/
  const SUPABASE_URL = "https://cthfqhxnplyibdsjzcrq.supabase.co";
  const SUPABASE_KEY = "sb_publishable_AjGX1zKhV8kEyGMbvAKwQg_srda-oyI";

  let supabase;
  try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  } catch (e) {
    debug("Supabase –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç jsdelivr –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.\n" + e.message);
  }

  /***********************
   * 2) STATE
   ***********************/
  const state = {
    products: [],
    filtered: [],
    categories: ["–í—Å–µ"],
    selectedCategory: "–í—Å–µ",
    search: "",
    fav: new Set(),
    cart: new Map(), // id -> qty
  };

  const LS_FAV = "nutrilab_fav_v1";
  const LS_CART = "nutrilab_cart_v1";

  function rub(n){
    const x = Number(n || 0);
    return isFinite(x) ? Math.round(x).toLocaleString('ru-RU') : "0";
  }

  function safeText(v){
    return (v === null || v === undefined) ? "" : String(v);
  }

  function loadStorage(){
    try {
      const favArr = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
      state.fav = new Set(favArr.map(Number));
    } catch {}
    try {
      const cartObj = JSON.parse(localStorage.getItem(LS_CART) || "{}");
      state.cart = new Map(Object.entries(cartObj).map(([k,v]) => [Number(k), Number(v)]));
    } catch {}
  }

  function saveStorage(){
    localStorage.setItem(LS_FAV, JSON.stringify([...state.fav]));
    const cartObj = {};
    for (const [id, qty] of state.cart.entries()) cartObj[id] = qty;
    localStorage.setItem(LS_CART, JSON.stringify(cartObj));
  }

  /***********************
   * 3) TELEGRAM
   ***********************/
  const tg = window.Telegram?.WebApp;
  function initTelegram(){
    try{
      if (!tg) return;
      tg.ready();
      tg.expand();
      // –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É/—Ü–≤–µ—Ç–∞ ‚Äî –ø–æ–∫–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.
    }catch(e){
      debug("Telegram init error: " + e.message);
    }
  }

  /***********************
   * 4) LOAD PRODUCTS FROM SUPABASE
   ***********************/
  async function loadProducts(){
    if (!supabase) return;
    debug("–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Supabase...");

    // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–±—Ä–∞—Ç—å –ø–æ–ª—è, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∫–∏—Ö-—Ç–æ –Ω–µ—Ç ‚Äî Supabase –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—è —Ä–µ–∞–ª—å–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
    // –ü–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º select("*") –∏ —É–∂–µ –≤ JS –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –Ω—É–∂–Ω–æ–µ.
    const { data, error } = await supabase
      .from("products")
      .select("*")
      .order("id", { ascending: true });

    if (error){
      debug("–û—à–∏–±–∫–∞ Supabase:\n" + error.message + "\n\n–ß–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞: RLS –±–µ–∑ policy –Ω–∞ SELECT.");
      return;
    }

    state.products = Array.isArray(data) ? data : [];
    debug("–¢–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑–µ: " + state.products.length);

    // –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const cats = new Set(["–í—Å–µ"]);
    for (const p of state.products){
      if (p.category) cats.add(String(p.category));
    }
    state.categories = [...cats];
    state.selectedCategory = "–í—Å–µ";

    applyFilters();
    renderCategories();
    renderHome();
    renderFav();
    renderCart();
  }

  function applyFilters(){
    const q = state.search.trim().toLowerCase();
    state.filtered = state.products.filter(p => {
      const name = safeText(p.name).toLowerCase();
      const desc = safeText(p.description).toLowerCase();
      const cat = safeText(p.category);

      const okCat = state.selectedCategory === "–í—Å–µ" ? true : (cat === state.selectedCategory);
      const okSearch = !q ? true : (name.includes(q) || desc.includes(q));
      return okCat && okSearch;
    });
  }

  /***********************
   * 5) UI RENDER
   ***********************/
  const elTabs = document.getElementById('categoryTabs');
  const elSearch = document.getElementById('searchInput');

  const elHomeGrid = document.getElementById('productsGrid');
  const elHomeEmpty = document.getElementById('homeEmpty');

  const elFavGrid = document.getElementById('favGrid');
  const elFavEmpty = document.getElementById('favEmpty');

  const elCartList = document.getElementById('cartList');
  const elCartEmpty = document.getElementById('cartEmpty');
  const elCartTotal = document.getElementById('cartTotal');

  function renderCategories(){
    elTabs.innerHTML = "";
    for (const c of state.categories){
      const chip = document.createElement('div');
      chip.className = "tabChip" + (c === state.selectedCategory ? " active" : "");
      chip.textContent = c;
      chip.onclick = () => {
        state.selectedCategory = c;
        applyFilters();
        renderCategories();
        renderHome();
      };
      elTabs.appendChild(chip);
    }
  }

  function productCard(p){
    const id = Number(p.id);
    const name = safeText(p.name) || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
    const description = safeText(p.description) || "–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è";
    const price = p.price ?? 0;

    // –ï—Å–ª–∏ image_url –ø—É—Å—Ç–æ–π ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
    const img = safeText(p.image_url) || "https://via.placeholder.com/600x400?text=NutriLab";

    const card = document.createElement('div');
    card.className = "card";

    const imgBox = document.createElement('div');
    imgBox.className = "imgBox";
    imgBox.innerHTML = `<img src="${img}" alt="${name}" loading="lazy" onerror="this.src='https://via.placeholder.com/600x400?text=No+Image'">`;

    const favBtn = document.createElement('div');
    favBtn.className = "favBtn" + (state.fav.has(id) ? " active" : "");
    favBtn.textContent = state.fav.has(id) ? "‚ù§Ô∏è" : "ü§ç";
    favBtn.onclick = (e) => {
      e.stopPropagation();
      toggleFav(id);
      favBtn.className = "favBtn" + (state.fav.has(id) ? " active" : "");
      favBtn.textContent = state.fav.has(id) ? "‚ù§Ô∏è" : "ü§ç";
    };
    imgBox.appendChild(favBtn);

    const body = document.createElement('div');
    body.className = "cardBody";
    body.innerHTML = `
      <div class="title">${name}</div>
      <div class="desc">${description}</div>
      <div class="row">
        <div class="price">${rub(price)} ‚ÇΩ</div>
        <div style="color:var(--muted);font-weight:800;font-size:12px">${safeText(p.category || "")}</div>
      </div>
    `;

    const btnRow = document.createElement('div');
    btnRow.className = "btnRow";

    const toCart = document.createElement('div');
    toCart.className = "btn primary";
    toCart.textContent = "üõí –í –∫–æ—Ä–∑–∏–Ω—É";
    toCart.onclick = () => addToCart(id, 1);

    const buy = document.createElement('div');
    buy.className = "btn";
    buy.textContent = "‚úÖ –ö—É–ø–∏—Ç—å";
    buy.onclick = () => {
      addToCart(id, 1);
      switchScreen("cart");
    };

    btnRow.appendChild(toCart);
    btnRow.appendChild(buy);
    body.appendChild(btnRow);

    card.appendChild(imgBox);
    card.appendChild(body);
    return card;
  }

  function renderHome(){
    elHomeGrid.innerHTML = "";
    if (!state.filtered.length){
      elHomeEmpty.style.display = "block";
      elHomeEmpty.textContent = "–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–∏—Å–∫/–∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –¥–æ–±–∞–≤—å —Ç–æ–≤–∞—Ä—ã –≤ Supabase.";
      return;
    }
    elHomeEmpty.style.display = "none";
    for (const p of state.filtered){
      elHomeGrid.appendChild(productCard(p));
    }
  }

  function renderFav(){
    const favProducts = state.products.filter(p => state.fav.has(Number(p.id)));
    elFavGrid.innerHTML = "";
    if (!favProducts.length){
      elFavEmpty.style.display = "block";
      elFavEmpty.textContent = "–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ ‚ù§Ô∏è –Ω–∞ —Ç–æ–≤–∞—Ä–µ.";
      return;
    }
    elFavEmpty.style.display = "none";
    for (const p of favProducts){
      elFavGrid.appendChild(productCard(p));
    }
  }

  function renderCart(){
    const items = [];
    for (const [id, qty] of state.cart.entries()){
      const p = state.products.find(x => Number(x.id) === id);
      if (p) items.push({ p, qty });
    }

    elCartList.innerHTML = "";
    if (!items.length){
      elCartEmpty.style.display = "block";
      elCartEmpty.textContent = "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å —Ç–æ–≤–∞—Ä—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π.";
      elCartTotal.textContent = "0";
      return;
    }
    elCartEmpty.style.display = "none";

    let total = 0;

    for (const {p, qty} of items){
      const id = Number(p.id);
      const price = Number(p.price || 0);
      total += price * qty;

      const row = document.createElement('div');
      row.className = "empty";
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.gap = "10px";

      row.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:1000">${safeText(p.name)}</div>
          <div style="color:var(--muted);margin-top:2px">${rub(price)} ‚ÇΩ √ó ${qty}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <div class="btn" style="padding:10px 12px" data-dec>‚àí</div>
          <div style="min-width:22px;text-align:center;font-weight:1000">${qty}</div>
          <div class="btn primary" style="padding:10px 12px" data-inc>+</div>
          <div class="btn" style="padding:10px 12px;border-color:rgba(255,93,93,.35);background:rgba(255,93,93,.10)" data-del>üóë</div>
        </div>
      `;

      row.querySelector('[data-dec]').onclick = () => addToCart(id, -1);
      row.querySelector('[data-inc]').onclick = () => addToCart(id, +1);
      row.querySelector('[data-del]').onclick = () => removeFromCart(id);

      elCartList.appendChild(row);
    }

    elCartTotal.textContent = rub(total);
  }

  /***********************
   * 6) ACTIONS
   ***********************/
  function toggleFav(id){
    if (state.fav.has(id)) state.fav.delete(id);
    else state.fav.add(id);
    saveStorage();
    renderFav();
  }

  function addToCart(id, delta){
    const cur = Number(state.cart.get(id) || 0);
    const next = cur + delta;
    if (next <= 0) state.cart.delete(id);
    else state.cart.set(id, next);
    saveStorage();
    renderCart();
  }

  function removeFromCart(id){
    state.cart.delete(id);
    saveStorage();
    renderCart();
  }

  /***********************
   * 7) NAV + SCREEN SWITCH
   ***********************/
  const screens = {
    home: document.getElementById('screen-home'),
    fav: document.getElementById('screen-fav'),
    cart: document.getElementById('screen-cart'),
    profile: document.getElementById('screen-profile'),
  };

  function switchScreen(name){
    for (const k of Object.keys(screens)){
      screens[k].style.display = (k === name) ? "block" : "none";
    }
    document.querySelectorAll('.navBtn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.screen === name);
    });
    if (name === "fav") renderFav();
    if (name === "cart") renderCart();
  }

  document.querySelectorAll('.navBtn').forEach(btn => {
    btn.onclick = () => switchScreen(btn.dataset.screen);
  });

  /***********************
   * 8) PROFILE / BUTTONS
   ***********************/
  document.getElementById('clearFavBtn').onclick = () => {
    state.fav.clear();
    saveStorage();
    renderFav();
  };
  document.getElementById('clearCartBtn').onclick = () => {
    state.cart.clear();
    saveStorage();
    renderCart();
  };
  document.getElementById('reloadBtn').onclick = () => loadProducts();

  document.getElementById('checkoutBtn').onclick = () => {
    // –¢—É—Ç –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–∫–∞–∑ –≤ Telegram/–±–æ—Ç–∞ ‚Äî –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–∞–≤
    const lines = [];
    let total = 0;

    for (const [id, qty] of state.cart.entries()){
      const p = state.products.find(x => Number(x.id) === id);
      if (!p) continue;
      const price = Number(p.price || 0);
      total += price * qty;
      lines.push(`${safeText(p.name)} √ó ${qty} = ${rub(price*qty)} ‚ÇΩ`);
    }
    lines.push(`–ò—Ç–æ–≥–æ: ${rub(total)} ‚ÇΩ`);

    const msg = "–ó–∞–∫–∞–∑:\n" + lines.join("\n");

    if (tg) {
      // –í –¢–µ–ª–µ–≥—Ä–∞–º–µ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É —á–µ—Ä–µ–∑ tg.sendData
      tg.sendData(JSON.stringify({ type: "order", text: msg, total }));
      tg.showAlert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç–∞ ‚úÖ");
    } else {
      alert(msg);
    }
  };

  document.getElementById('orderBtn').onclick = () => switchScreen("cart");

  /***********************
   * 9) SEARCH
   ***********************/
  elSearch.addEventListener('input', () => {
    state.search = elSearch.value || "";
    applyFilters();
    renderHome();
  });

  /***********************
   * 10) INIT
   ***********************/
  function renderProfile(){
    const info = [];
    if (tg){
      const u = tg.initDataUnsafe?.user;
      if (u){
        info.push(`–ò–º—è: ${u.first_name || ""} ${u.last_name || ""}`.trim());
        if (u.username) info.push(`Username: @${u.username}`);
        info.push(`ID: ${u.id}`);
      } else {
        info.push("–û—Ç–∫—Ä—ã—Ç–æ –≤ Telegram WebApp, –Ω–æ user-–¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç.");
      }
      info.push("–°—Ä–µ–¥–∞: Telegram");
    } else {
      info.push("–°—Ä–µ–¥–∞: Safari/Browser");
    }
    document.getElementById('profileText').textContent = info.join("\n");
  }

  (async function init(){
    initTelegram();
    loadStorage();
    renderProfile();
    renderCategories();
    applyFilters();
    renderHome();
    renderFav();
    renderCart();
    await loadProducts();
  })();
</script>

</body>
</html>
