<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NutriLab Health Store</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg1:#051a1c;
      --bg2:#082a2b;
      --text:#e7fbff;
      --muted:#a8c6cc;
      --brand:#20d3b7;
      --brand2:#12b59a;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 22px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, #0e5d53 0%, transparent 60%),
                  radial-gradient(900px 900px at 90% 20%, #0f4a4f 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
      padding-bottom: 92px;
    }
    .container{ max-width: 980px; margin:0 auto; padding: 18px 14px; }

    .topbar{
      display:flex; align-items:center; gap:12px;
      padding: 10px 10px; border-radius: 20px;
      background: rgba(10,45,48,.65);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.06);
      position: sticky; top: 10px; z-index: 20;
    }
    .logo{
      width:44px;height:44px;border-radius: 14px;
      background: linear-gradient(135deg, var(--brand), #2bffd8);
      box-shadow: 0 12px 30px rgba(32,211,183,.25);
      flex: 0 0 auto;
    }
    .brand{ display:flex; flex-direction: column; gap:2px; min-width: 120px; }
    .brand .t1{ font-weight: 800; letter-spacing:.2px; }
    .brand .t2{ font-size: 12px; color: var(--muted); }

    .searchWrap{
      flex: 1 1 auto; display:flex; align-items:center; gap:10px;
      padding: 10px 12px; border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.06);
    }
    .searchWrap input{
      width:100%; background: transparent; border:0; outline:0;
      color: var(--text); font-size: 15px;
    }
    .searchWrap input::placeholder{ color: rgba(231,251,255,.55); }

    .btn{
      border:0; padding: 10px 14px; border-radius: 16px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color: #032224; font-weight: 800; cursor:pointer;
      box-shadow: 0 10px 25px rgba(32,211,183,.22);
      display:flex; align-items:center; gap:8px; white-space: nowrap;
    }

    .chips{ display:flex; gap:10px; margin-top: 14px; overflow:auto; padding-bottom: 4px; }
    .chip{
      padding: 10px 14px; border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.06);
      color: var(--text); cursor:pointer; flex: 0 0 auto;
      font-weight: 700; opacity: .85;
    }
    .chip.active{
      background: linear-gradient(135deg, rgba(32,211,183,.35), rgba(18,181,154,.18));
      border: 1px solid rgba(32,211,183,.35);
      opacity: 1;
    }

    .screen{ display:none; margin-top: 14px; }
    .screen.active{ display:block; }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-top: 14px;
    }
    @media (min-width: 820px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.07);
      box-shadow: var(--shadow);
      overflow:hidden;
      position: relative;
      min-height: 290px;
    }
    .card .img{
      width:100%;
      aspect-ratio: 1/1;
      background: rgba(0,0,0,.2);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .card .img img{ width:100%; height:100%; object-fit: cover; display:block; transform: scale(1.02); }
    .favBtn{
      position:absolute; top: 12px; right: 12px;
      width: 40px; height: 40px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
    }
    .favBtn.active{
      background: rgba(255, 60, 120, .18);
      border-color: rgba(255, 60, 120, .35);
    }
    .cardBody{ padding: 12px 12px 14px; display:flex; flex-direction: column; gap: 8px; }
    .title{ font-weight: 900; letter-spacing:.2px; font-size: 15px; line-height: 1.2; min-height: 36px; }
    .desc{
      font-size: 12px; color: var(--muted); line-height: 1.35;
      min-height: 32px; overflow:hidden;
      display:-webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    }
    .row{ display:flex; align-items:center; justify-content: space-between; gap:10px; margin-top: 2px; }
    .price{ font-size: 20px; font-weight: 900; }
    .mini{ display:flex; gap:10px; margin-top: 6px; }
    .btn2{
      flex:1; border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 11px 12px;
      border-radius: 18px;
      font-weight: 900;
      cursor:pointer;
    }
    .btn2.primary{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#032224;
      border:0;
    }
    .empty{
      margin-top: 22px;
      padding: 16px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.15);
      color: rgba(231,251,255,.85);
      white-space: pre-wrap;
    }

    .tabs{
      position: fixed; left:0; right:0; bottom:0;
      padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
      background: rgba(8,26,28,.75);
      border-top: 1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(16px);
      z-index: 50;
    }
    .tabRow{ max-width: 980px; margin:0 auto; display:flex; gap: 12px; }
    .tab{
      flex:1; padding: 12px 10px; border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      color: rgba(231,251,255,.9);
      font-weight: 900;
      display:flex; align-items:center; justify-content:center; gap:8px;
      cursor:pointer; user-select:none;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(32,211,183,.45), rgba(18,181,154,.22));
      border-color: rgba(32,211,183,.35);
      color: var(--text);
    }
    .badge{
      font-size: 12px; padding: 2px 8px; border-radius: 999px;
      background: rgba(32,211,183,.20);
      border: 1px solid rgba(32,211,183,.35);
    }

    /* DEBUG BOX */
    .debugBox{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .debugTitle{ font-weight: 900; margin-bottom: 6px; }
    .ok{ color: #7dffcf; }
    .bad{ color: #ff9a9a; }
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="logo"></div>
      <div class="brand">
        <div class="t1">NutriLab Health</div>
        <div class="t2">Premium Supplements</div>
      </div>

      <div class="searchWrap">
        <span>üîé</span>
        <input id="search" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." />
      </div>

      <button class="btn" id="orderBtn">‚úâÔ∏è –ó–∞–∫–∞–∑</button>
    </div>

    <!-- DEBUG -->
    <div class="debugBox" id="debugBox">
      <div class="debugTitle">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–≤–µ—Ä—Å–∏—è 1.0-debug)</div>
      <div id="dbg">–°—Ç–∞—Ä—Ç‚Ä¶</div>
    </div>

    <div class="chips" id="chips"></div>

    <div class="screen active" id="screenHome">
      <div class="grid" id="grid"></div>
      <div class="empty" id="emptyHome" style="display:none;"></div>
    </div>

    <div class="screen" id="screenFav">
      <div class="grid" id="gridFav"></div>
      <div class="empty" id="emptyFav" style="display:none;"></div>
    </div>

    <div class="screen" id="screenCart">
      <div class="empty" id="emptyCart">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è.</div>
      <div class="empty" style="margin-top:12px;">
        (–í debug-–≤–µ—Ä—Å–∏–∏ –∫–æ—Ä–∑–∏–Ω—É –Ω–µ —É—Å–ª–æ–∂–Ω—è–µ–º ‚Äî –Ω–∞–º –≤–∞–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —É–≤–∏–¥–µ—Ç—å, –≥—Ä—É–∑–∏—Ç –ª–∏ Supabase.)
      </div>
    </div>

    <div class="screen" id="screenProfile">
      <div class="empty" id="profileText">–ü—Ä–æ—Ñ–∏–ª—å‚Ä¶</div>
    </div>

  </div>

  <div class="tabs">
    <div class="tabRow">
      <div class="tab active" data-tab="home">üè† –ì–ª–∞–≤–Ω–∞—è</div>
      <div class="tab" data-tab="fav">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ <span class="badge" id="favBadge">0</span></div>
      <div class="tab" data-tab="cart">üõí –ö–æ—Ä–∑–∏–Ω–∞ <span class="badge" id="cartBadge">0</span></div>
      <div class="tab" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
  </div>

  <script>
    /* ============ –¢–í–û–ô SUPABASE ============ */
    const SUPABASE_URL = "https://cthfqhxnplyibdsjzcrq.supabase.co";
    const SUPABASE_KEY = "sb_publishable_AjGX1zKhV8kEyGMbvAKwQg_srda-oyI";
    /* ====================================== */

    const dbgEl = document.getElementById("dbg");
    function dbg(msg, cls){
      const line = document.createElement("div");
      if (cls) line.className = cls;
      line.textContent = msg;
      dbgEl.appendChild(line);
      console.log("[DBG]", msg);
    }

    // —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –ø—Ä—è–º–æ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
    window.addEventListener("error", (e)=>{
      dbg("JS ERROR: " + (e.message || "unknown"), "bad");
    });
    window.addEventListener("unhandledrejection", (e)=>{
      dbg("PROMISE ERROR: " + (e.reason?.message || String(e.reason)), "bad");
    });

    let tg = null;
    let supabaseClient = null;
    let allProducts = [];
    let currentCategory = "–í—Å–µ";
    let searchQuery = "";

    const LS_FAV = "nutrilab_fav";
    const getFav = () => new Set(JSON.parse(localStorage.getItem(LS_FAV) || "[]"));
    const setFav = (set) => localStorage.setItem(LS_FAV, JSON.stringify([...set]));

    function initTelegram(){
      try{
        tg = window.Telegram?.WebApp || null;
        if (tg){
          tg.ready();
          tg.expand();
          dbg("Telegram WebApp: OK", "ok");
        } else {
          dbg("Telegram WebApp: –Ω–µ—Ç (–±—Ä–∞—É–∑–µ—Ä)", "ok");
        }
      }catch(e){
        dbg("Telegram init error: " + e.message, "bad");
      }
    }

    function renderProfile(){
      const el = document.getElementById("profileText");
      const u = tg?.initDataUnsafe?.user;
      if (u){
        el.textContent = `–ò–º—è: ${(u.first_name||"")} ${(u.last_name||"")}\nUsername: ${u.username?("@"+u.username):"-"}\nID: ${u.id}`;
      } else {
        el.textContent = "–û—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–Ω–µ Telegram WebApp).";
      }
    }

    function fmtPrice(v){
      const n = Number(v || 0);
      return n.toLocaleString("ru-RU") + " ‚ÇΩ";
    }

    function getCategories(products){
      const set = new Set();
      products.forEach(p => { if (p.category) set.add(String(p.category)); });
      return ["–í—Å–µ", ...[...set].sort((a,b)=>a.localeCompare(b,'ru'))];
    }

    function filteredProducts(){
      return allProducts.filter(p=>{
        if (currentCategory !== "–í—Å–µ" && String(p.category||"") !== currentCategory) return false;
        if (searchQuery){
          const s = searchQuery.toLowerCase();
          const t = `${p.name||""} ${p.description||""}`.toLowerCase();
          if (!t.includes(s)) return false;
        }
        return true;
      });
    }

    function renderCategories(){
      const chips = document.getElementById("chips");
      chips.innerHTML = "";
      const cats = getCategories(allProducts);
      cats.forEach(c=>{
        const b = document.createElement("button");
        b.className = "chip" + (c===currentCategory ? " active": "");
        b.textContent = c;
        b.onclick = ()=>{
          currentCategory = c;
          renderCategories();
          renderHome();
        };
        chips.appendChild(b);
      });
    }

    function updateBadges(){
      const fav = getFav();
      document.getElementById("favBadge").textContent = fav.size;
      document.getElementById("cartBadge").textContent = "0";
    }

    function productCard(p){
      const fav = getFav();
      const inFav = fav.has(p.id);

      const card = document.createElement("div");
      card.className = "card";
      const imgUrl = p.image_url || "https://via.placeholder.com/600x600?text=NutriLab";

      card.innerHTML = `
        <div class="img"><img src="${imgUrl}" alt=""></div>
        <div class="favBtn ${inFav ? "active": ""}">${inFav ? "‚ù§Ô∏è" : "ü§ç"}</div>
        <div class="cardBody">
          <div class="title">${p.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</div>
          <div class="desc">${p.description || ""}</div>
          <div class="row">
            <div class="price">${fmtPrice(p.price)}</div>
            <div style="color:var(--muted); font-size:12px;">${p.category ? p.category : ""}</div>
          </div>
          <div class="mini">
            <button class="btn2 primary" data-act="buy">–ö—É–ø–∏—Ç—å</button>
          </div>
        </div>
      `;

      card.querySelector(".favBtn").onclick = ()=>{
        const s = getFav();
        if (s.has(p.id)) s.delete(p.id); else s.add(p.id);
        setFav(s);
        updateBadges();
        renderFav();
        renderHome();
      };

      card.querySelector('[data-act="buy"]').onclick = ()=>{
        // –≤ debug-–≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫–∏
        alert("–ö–ª–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ");
      };

      return card;
    }

    function renderHome(){
      const grid = document.getElementById("grid");
      const empty = document.getElementById("emptyHome");
      grid.innerHTML = "";
      const arr = filteredProducts();

      if (!arr.length){
        empty.style.display = "block";
        empty.textContent =
          "–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç.\n\n–ï—Å–ª–∏ –≤ Supabase —Ç–æ–≤–∞—Ä—ã –µ—Å—Ç—å ‚Äî –∑–Ω–∞—á–∏—Ç SELECT –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç.\n" +
          "–ß–∞—â–µ –≤—Å–µ–≥–æ –ø—Ä–∏—á–∏–Ω–∞: RLS –≤–∫–ª—é—á—ë–Ω –±–µ–∑ policy.\n\n" +
          "–û—Ç–∫—Ä–æ–π Supabase ‚Üí Table Editor ‚Üí products ‚Üí RLS:\n" +
          "‚Ä¢ –ª–∏–±–æ –≤—Ä–µ–º–µ–Ω–Ω–æ Disable RLS\n" +
          "‚Ä¢ –ª–∏–±–æ –¥–æ–±–∞–≤—å policy –Ω–∞ SELECT –¥–ª—è anon.";
        return;
      }

      empty.style.display = "none";
      arr.forEach(p=>grid.appendChild(productCard(p)));
    }

    function renderFav(){
      const grid = document.getElementById("gridFav");
      const empty = document.getElementById("emptyFav");
      grid.innerHTML = "";

      const fav = getFav();
      const arr = allProducts.filter(p=>fav.has(p.id));

      if (!arr.length){
        empty.style.display = "block";
        empty.textContent = "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ–µ.";
        return;
      }
      empty.style.display = "none";
      arr.forEach(p=>grid.appendChild(productCard(p)));
    }

    function switchTab(tab){
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add("active");

      if (tab === "home") document.getElementById("screenHome").classList.add("active");
      if (tab === "fav") document.getElementById("screenFav").classList.add("active");
      if (tab === "cart") document.getElementById("screenCart").classList.add("active");
      if (tab === "profile") document.getElementById("screenProfile").classList.add("active");

      if (tab === "home") renderHome();
      if (tab === "fav") renderFav();
      if (tab === "profile") renderProfile();
    }

    // –∑–∞–≥—Ä—É–∑–∫–∞ supabase –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å fallback (–µ—Å–ª–∏ jsdelivr –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω)
    function loadSupabaseLib(){
      return new Promise((resolve, reject)=>{
        const tryLoad = (src, next)=>{
          const s = document.createElement("script");
          s.src = src;
          s.onload = ()=> resolve();
          s.onerror = ()=> next ? next() : reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å supabase-js"));
          document.head.appendChild(s);
        };

        dbg("–ì—Ä—É–∂—É supabase-js‚Ä¶");
        tryLoad(
          "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js",
          ()=> tryLoad("https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js")
        );
      });
    }

    async function loadProducts(){
      dbg("–®–∞–≥: loadProducts()");

      if (!window.supabase){
        dbg("supabase-js –ù–ï –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (window.supabase –ø—É—Å—Ç–æ–π)", "bad");
        return;
      }

      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      dbg("Supabase client: OK", "ok");

      dbg("–ó–∞–ø—Ä–æ—Å: select * from products ‚Ä¶");
      const { data, error } = await supabaseClient
        .from("products")
        .select("*")
        .order("id", { ascending: true });

      if (error){
        dbg("Supabase ERROR: " + error.message, "bad");
        dbg("–ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ RLS ON ‚Äî —Å–¥–µ–ª–∞–π policy –Ω–∞ SELECT –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏ RLS.", "bad");
        return;
      }

      allProducts = Array.isArray(data) ? data : [];
      dbg("Supabase OK. –¢–æ–≤–∞—Ä–æ–≤: " + allProducts.length, allProducts.length ? "ok" : "bad");

      renderCategories();
      renderHome();
      renderFav();
      updateBadges();
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      dbg("DOM loaded ‚úÖ", "ok");

      initTelegram();
      renderProfile();

      document.getElementById("search").addEventListener("input", (e)=>{
        searchQuery = (e.target.value || "").trim();
        renderHome();
      });

      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=> switchTab(t.dataset.tab));
      });

      document.getElementById("orderBtn").onclick = ()=> alert("–ö–Ω–æ–ø–∫–∞ '–ó–∞–∫–∞–∑' –∫–ª–∏–∫–∞–µ—Ç—Å—è ‚úÖ");

      updateBadges();

      try{
        await loadSupabaseLib();
        dbg("supabase-js –∑–∞–≥—Ä—É–∂–µ–Ω ‚úÖ", "ok");
        await loadProducts();
      }catch(e){
        dbg("LOAD ERROR: " + e.message, "bad");
      }
    });
  </script>
</body>
</html>
