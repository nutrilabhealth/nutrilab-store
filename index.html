<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NutriLab Store</title>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0B0F12;
      --panel:#0F161B;
      --panel2:#111B22;
      --line:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --accent:#18B38A;   /* —Å–∏–Ω–µ-–∑–µ–ª—ë–Ω—ã–π */
      --accent2:#0D7E62;  /* —Ç—ë–º–Ω–µ–µ */
      --danger:#E05252;
      --ok:#2BD67B;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:14px;
      --tap: 44px;
      --max: 980px;
      --font: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,system-ui,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 900px at 20% -10%, rgba(24,179,138,.18), transparent 50%),
                  radial-gradient(1000px 800px at 95% 10%, rgba(17,116,104,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding: 18px 14px calc(92px + env(safe-area-inset-bottom));
    }

    /* Top bar */
    .top{
      position:sticky; top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,18,.92), rgba(11,15,18,.55));
      border-bottom: 1px solid var(--line);
    }
    .top-inner{
      max-width:var(--max);
      margin:0 auto;
      padding: 14px 14px 12px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 160px;
    }
    .mark{
      width:34px; height:34px; border-radius:12px;
      background: radial-gradient(10px 10px at 30% 30%, rgba(255,255,255,.25), transparent 60%),
                  linear-gradient(135deg, rgba(24,179,138,1), rgba(13,126,98,1));
      box-shadow: 0 10px 25px rgba(24,179,138,.25);
    }
    .brand-txt{line-height:1.05}
    .brand-txt b{display:block; font-size:14px; letter-spacing:.2px}
    .brand-txt span{display:block; font-size:12px; color:var(--muted)}

    .search{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 10px 12px;
      min-height: var(--tap);
    }
    .search input{
      width:100%;
      background: transparent;
      border:none; outline:none;
      color:var(--text);
      font-size:14px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(24,179,138,.10);
      border: 1px solid rgba(24,179,138,.25);
      color: rgba(255,255,255,.86);
      font-size: 13px;
      min-height: var(--tap);
      white-space:nowrap;
    }

    /* Sections */
    .section{
      margin-top:14px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .section-h{
      padding: 14px 14px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(to bottom, rgba(255,255,255,.03), transparent);
      border-bottom: 1px solid var(--line);
    }
    .section-h .title{
      font-size:14px;
      letter-spacing:.2px;
    }
    .section-h .sub{
      font-size:12px;
      color:var(--muted);
    }

    .cats{
      padding: 12px 12px 10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .cat{
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      font-size:13px;
      color:rgba(255,255,255,.86);
      cursor:pointer;
      user-select:none;
    }
    .cat.active{
      background: rgba(24,179,138,.14);
      border-color: rgba(24,179,138,.35);
    }

    /* Grid */
    .grid{
      padding: 12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    @media (min-width: 720px){
      .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    }

    .card{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: 230px;
    }
    .img{
      position:relative;
      aspect-ratio: 1/1;
      background: linear-gradient(135deg, rgba(24,179,138,.18), rgba(255,255,255,.02));
    }
    .img img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.02);
    }
    .badge{
      position:absolute; left:10px; top:10px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      color: rgba(255,255,255,.85);
    }
    .favbtn{
      position:absolute; right:10px; top:10px;
      width:36px; height:36px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .favbtn.active{
      border-color: rgba(24,179,138,.45);
      background: rgba(24,179,138,.18);
    }
    .body{
      padding: 10px 10px 12px;
      display:flex; flex-direction:column; gap:8px;
      flex:1;
    }
    .name{
      font-size: 13.5px;
      line-height: 1.2;
      letter-spacing: .1px;
    }
    .desc{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
      min-height: 28px;
    }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:auto;
    }
    .price{
      font-weight: 700;
      font-size: 13.5px;
      color: rgba(255,255,255,.92);
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 12px;
      min-height: var(--tap);
      border-radius: 12px;
      border: 1px solid rgba(24,179,138,.35);
      background: linear-gradient(135deg, rgba(24,179,138,.22), rgba(13,126,98,.12));
      color: rgba(255,255,255,.92);
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn.secondary{
      background: rgba(255,255,255,.04);
      border-color: var(--line);
      color: rgba(255,255,255,.86);
    }
    .btn.danger{
      background: rgba(224,82,82,.12);
      border-color: rgba(224,82,82,.35);
    }

    /* Empty */
    .empty{
      padding: 22px 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* Cart list */
    .list{ padding: 10px 12px 14px; display:flex; flex-direction:column; gap:10px; }
    .item{
      display:flex; gap:10px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
    }
    .thumb{
      width:64px; height:64px; border-radius: 14px;
      background: rgba(255,255,255,.04);
      overflow:hidden; flex: 0 0 auto;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .it-b{ flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
    .it-t{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .it-name{ font-size: 13.5px; line-height:1.2; }
    .it-price{ font-weight: 700; font-size: 13.5px; white-space:nowrap; }
    .qty{
      display:flex; align-items:center; gap:8px;
      margin-top:2px;
    }
    .qbtn{
      width:36px; height:36px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .qnum{ min-width:22px; text-align:center; font-weight:700; }
    .it-actions{ display:flex; gap:10px; margin-top:4px; }
    .link{
      color: rgba(255,255,255,.78);
      font-size: 12.5px;
      text-decoration: underline;
      cursor:pointer;
      user-select:none;
    }

    /* Summary */
    .summary{
      padding: 12px 12px 14px;
      border-top: 1px solid var(--line);
      display:flex; flex-direction:column; gap:10px;
      background: linear-gradient(to bottom, transparent, rgba(255,255,255,.02));
    }
    .sumrow{ display:flex; justify-content:space-between; gap:10px; color: var(--muted); font-size: 13px; }
    .sumrow b{ color: rgba(255,255,255,.92); font-weight: 800; }
    .cta{ display:flex; gap:10px; flex-wrap:wrap; }

    /* Bottom nav */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding-bottom: env(safe-area-inset-bottom);
      background: rgba(11,15,18,.78);
      backdrop-filter: blur(12px);
      border-top: 1px solid var(--line);
      z-index: 20;
    }
    .nav-inner{
      max-width:var(--max);
      margin:0 auto;
      padding: 10px 10px;
      display:flex; gap:8px;
    }
    .tab{
      flex:1;
      min-height: 52px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:flex; align-items:center; justify-content:center; gap:8px;
      font-size: 13px;
      color: rgba(255,255,255,.84);
      position:relative;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(24,179,138,.35);
      background: rgba(24,179,138,.12);
    }
    .bcount{
      position:absolute;
      top:7px; right:10px;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 999px;
      background: rgba(24,179,138,.9);
      color: #06110E;
      font-weight: 800;
      font-size: 11px;
      display:flex; align-items:center; justify-content:center;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom: 90px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.9);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 50;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

    /* Small text blocks */
    .info{
      padding: 12px 12px 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .info b{ color: rgba(255,255,255,.9); }
    .hr{ height:1px; background: var(--line); margin: 10px 0; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace; font-size:12px; color: rgba(255,255,255,.78); }

  </style>
</head>

<body>

<div class="top">
  <div class="top-inner">
    <div class="brand" onclick="setView('home')">
      <div class="mark"></div>
      <div class="brand-txt">
        <b>NutriLab Health</b>
        <span>Premium Supplements</span>
      </div>
    </div>

    <div class="search" title="–ü–æ–∏—Å–∫">
      <span style="opacity:.7">üîé</span>
      <input id="q" type="text" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." autocomplete="off" />
    </div>

    <div class="chip" onclick="openOrdersChat()" title="–ó–∞–∫–∞–∑ –≤ Telegram">
      ‚úâÔ∏è <span>–ó–∞–∫–∞–∑</span>
    </div>
  </div>
</div>

<div class="wrap" id="app"></div>

<div class="nav">
  <div class="nav-inner">
    <div class="tab" id="tab-home" onclick="setView('home')">üè† –ì–ª–∞–≤–Ω–∞—è</div>
    <div class="tab" id="tab-fav" onclick="setView('fav')">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ <span class="bcount" id="b-fav" style="display:none"></span></div>
    <div class="tab" id="tab-cart" onclick="setView('cart')">üõí –ö–æ—Ä–∑–∏–Ω–∞ <span class="bcount" id="b-cart" style="display:none"></span></div>
    <div class="tab" id="tab-prof" onclick="setView('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/** =========================
 *  –ù–ê–°–¢–†–û–ô–ö–ò (—Ç–≤–æ–∏)
 *  ========================= */
const ORDER_USERNAME = "nutrilabhealth"; // –∫—É–¥–∞ —É—Ö–æ–¥—è—Ç –∑–∞–∫–∞–∑—ã
const SUPABASE_URL = "https://cthfqhxnplyibdsjzcrq.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_AjGX1zKhV8kEyGMbvAKwQg_srda-oyI";

/** =========================
 *  –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
 *  ========================= */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

const LS_KEY = "nutrilab_store_state_v2";
const state = loadState() || {
  view: "home",
  q: "",
  category: "–í—Å–µ",
  fav: [],               // array of product IDs (string)
  cart: {},              // { [id]: qty }
  products: [],          // loaded from Supabase
  loaded: false,
  lastError: null
};

const app = document.getElementById("app");
const qInput = document.getElementById("q");

qInput.addEventListener("input", () => {
  state.q = qInput.value.trim();
  saveState();
  if (state.view !== "home") setView("home");
  else render();
});

tryInitTelegram();

(async function init(){
  await loadProducts();
  render();
  updateBadges();
})();

/** =========================
 *  SUPABASE: –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
 *  ========================= */
async function loadProducts(){
  state.loaded = false;
  state.lastError = null;
  render(); // –ø–æ–∫–∞–∂–µ–º –∑–∞–≥—Ä—É–∑–∫—É

  const { data, error } = await supabase
    .from("products")
    .select("id,name,price,description,image_url")
    .order("id", { ascending: true });

  if (error) {
    state.lastError = error.message || String(error);
    state.products = [];
    state.loaded = true;
    saveState();
    return;
  }

  // –ü—Ä–∏–≤–æ–¥–∏–º —Ç–∏–ø—ã –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ–ª—è
  state.products = (data || []).map(p => ({
    id: String(p.id),
    name: (p.name ?? "").toString(),
    price: Number(p.price ?? 0),
    description: (p.description ?? "").toString(),
    image_url: (p.image_url ?? "").toString(),
    category: "–ë–ê–î—ã"
  }));

  state.loaded = true;
  saveState();
}

/** =========================
 *  VIEW
 *  ========================= */
function setView(v){
  state.view = v;
  saveState();
  render();
  updateBadges();
  setTabs();
  // –ª–µ–≥–∫–∏–π UX
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function setTabs(){
  ["home","fav","cart","profile"].forEach(x=>{
    const el = document.getElementById("tab-"+(x==="profile"?"prof":x));
    if (!el) return;
    el.classList.toggle("active", state.view === x);
  });
}
setTabs();

function render(){
  setTabs();
  qInput.value = state.q || "";

  if (!state.loaded) {
    app.innerHTML = `
      <div class="section">
        <div class="section-h">
          <div>
            <div class="title">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞‚Ä¶</div>
            <div class="sub">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ —Ç–æ–≤–∞—Ä–æ–≤</div>
          </div>
          <div class="chip" onclick="loadProducts().then(()=>{render();updateBadges();})">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</div>
        </div>
        <div class="empty">–ï—Å–ª–∏ –¥–æ–ª–≥–æ –≥—Ä—É–∑–∏—Ç—Å—è ‚Äî –ø—Ä–æ–≤–µ—Ä—å RLS –≤ Supabase (–¥–æ—Å—Ç—É–ø –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã <b>products</b>).</div>
      </div>
    `;
    return;
  }

  if (state.lastError) {
    app.innerHTML = `
      <div class="section">
        <div class="section-h">
          <div>
            <div class="title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Supabase</div>
            <div class="sub">–ß–∞—â–µ –≤—Å–µ–≥–æ —ç—Ç–æ RLS / Policies</div>
          </div>
          <div class="chip" onclick="loadProducts().then(()=>{render();updateBadges();})">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</div>
        </div>
        <div class="info">
          <div><b>–¢–µ–∫—Å—Ç:</b> ${escapeHtml(state.lastError)}</div>
          <div class="hr"></div>
          <div><b>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ Supabase:</b></div>
          <div>Table Editor ‚Üí <b>products</b> ‚Üí RLS/Policies ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –Ω–∞ <b>SELECT</b> –¥–ª—è Public/Anon (—É—Å–ª–æ–≤–∏–µ <span class="mono">true</span>).</div>
        </div>
      </div>
    `;
    return;
  }

  if (state.view === "home") return renderHome();
  if (state.view === "fav") return renderFav();
  if (state.view === "cart") return renderCart();
  if (state.view === "profile") return renderProfile();
}

/** =========================
 *  HOME
 *  ========================= */
function renderHome(){
  const cats = ["–í—Å–µ", "–ë–ê–î—ã"];
  const filtered = getFilteredProducts();

  app.innerHTML = `
    <div class="section">
      <div class="section-h">
        <div>
          <div class="title">–ö–∞—Ç–∞–ª–æ–≥</div>
          <div class="sub">–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –≤–∏—Ç–∞–º–∏–Ω—ã –∏ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã ‚Ä¢ –ó–∞–∫–∞–∑ –≤ Telegram</div>
        </div>
        <div class="chip" onclick="loadProducts().then(()=>{toast('–ö–∞—Ç–∞–ª–æ–≥ –æ–±–Ω–æ–≤–ª—ë–Ω');render();updateBadges();})">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</div>
      </div>

      <div class="cats">
        ${cats.map(c => `<div class="cat ${state.category===c?'active':''}" onclick="setCategory('${c}')">${c}</div>`).join("")}
      </div>

      ${filtered.length ? `
        <div class="grid">
          ${filtered.map(p => productCard(p)).join("")}
        </div>
      ` : `
        <div class="empty">
          –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É <b>${escapeHtml(state.q || "‚Äî")}</b>.<br/>
          –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ—á–∏—Å—Ç–∏ –ø–æ–∏—Å–∫.
        </div>
      `}
    </div>
  `;
}

function setCategory(c){
  state.category = c;
  saveState();
  render();
}

/** =========================
 *  FAVORITES
 *  ========================= */
function renderFav(){
  const favSet = new Set(state.fav || []);
  const items = state.products.filter(p => favSet.has(p.id));

  app.innerHTML = `
    <div class="section">
      <div class="section-h">
        <div>
          <div class="title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
          <div class="sub">–¢–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –æ—Ç–º–µ—Ç–∏–ª</div>
        </div>
        ${items.length ? `<div class="chip" onclick="clearFav()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</div>` : `<div class="chip" onclick="setView('home')">üõç –í –∫–∞—Ç–∞–ª–æ–≥</div>`}
      </div>

      ${items.length ? `
        <div class="grid">
          ${items.map(p => productCard(p)).join("")}
        </div>
      ` : `
        <div class="empty">
          –ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤–ª—è–π —Ç–æ–≤–∞—Ä—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ —Å–µ—Ä–¥–µ—á–∫–æ–º ‚ù§Ô∏è
        </div>
      `}
    </div>
  `;
}

/** =========================
 *  CART
 *  ========================= */
function renderCart(){
  const ids = Object.keys(state.cart || {});
  const items = ids.map(id => {
    const p = state.products.find(x => x.id === id);
    if (!p) return null;
    return { p, qty: Number(state.cart[id] || 0) };
  }).filter(Boolean).filter(x => x.qty > 0);

  const total = items.reduce((s, x) => s + x.p.price * x.qty, 0);

  app.innerHTML = `
    <div class="section">
      <div class="section-h">
        <div>
          <div class="title">–ö–æ—Ä–∑–∏–Ω–∞</div>
          <div class="sub">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∏—Ç–æ–≥, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
        </div>
        ${items.length ? `<div class="chip" onclick="clearCart()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</div>` : `<div class="chip" onclick="setView('home')">üõç –í –∫–∞—Ç–∞–ª–æ–≥</div>`}
      </div>

      ${items.length ? `
        <div class="list">
          ${items.map(({p,qty}) => cartItem(p, qty)).join("")}
        </div>

        <div class="summary">
          <div class="sumrow"><span>–ü–æ–∑–∏—Ü–∏–π</span><b>${items.length}</b></div>
          <div class="sumrow"><span>–ò—Ç–æ–≥–æ</span><b>${formatPrice(total)} ‚ÇΩ</b></div>

          <div class="cta">
            <div class="btn" onclick="checkout()">‚úâÔ∏è –û—Ñ–æ—Ä–º–∏—Ç—å –≤ Telegram</div>
            <div class="btn secondary" onclick="setView('home')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë</div>
          </div>

          <div class="info" style="padding:0;color:var(--muted2)">
            –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –¥–µ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã ‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –†–§ (–°–î–≠–ö / –ü–æ—á—Ç–∞ / –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
          </div>
        </div>
      ` : `
        <div class="empty">
          –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è.<br/>
          –í—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –∏ –Ω–∞–∂–º–∏ <b>–í –∫–æ—Ä–∑–∏–Ω—É</b>.
        </div>
      `}
    </div>
  `;
}

/** =========================
 *  PROFILE
 *  ========================= */
function renderProfile(){
  app.innerHTML = `
    <div class="section">
      <div class="section-h">
        <div>
          <div class="title">–ü—Ä–æ—Ñ–∏–ª—å</div>
          <div class="sub">–ö–æ–Ω—Ç–∞–∫—Ç—ã, –¥–æ—Å—Ç–∞–≤–∫–∞, –æ–ø–ª–∞—Ç–∞</div>
        </div>
        <div class="chip" onclick="openOrdersChat()">‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</div>
      </div>

      <div class="info">
        <b>NutriLab Health</b> ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –≤–∏—Ç–∞–º–∏–Ω—ã –∏ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –æ—Ç –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤.<br/>
        –†–∞–±–æ—Ç–∞–µ–º —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏. –ü—Ä–æ–¥—É–∫—Ü–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è.

        <div class="hr"></div>

        <b>üì¶ –û—Ç–ø—Ä–∞–≤–∫–∞:</b> –≤ –¥–µ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã<br/>
        <b>üìç –î–æ—Å—Ç–∞–≤–∫–∞:</b> –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏ (–°–î–≠–ö / –ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏ / –ø–æ –∑–∞–ø—Ä–æ—Å—É WB/Ozon)<br/>
        <b>üí≥ –û–ø–ª–∞—Ç–∞:</b> –Ω–∞ –∫–∞—Ä—Ç—É / —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º –ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é

        <div class="hr"></div>

        <div class="cta">
          <div class="btn" onclick="openOrdersChat()">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç @${escapeHtml(ORDER_USERNAME)}</div>
          <div class="btn secondary" onclick="loadProducts().then(()=>{toast('–ö–∞—Ç–∞–ª–æ–≥ –æ–±–Ω–æ–≤–ª—ë–Ω');render();updateBadges();})">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥</div>
        </div>

        <div class="hr"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="btn secondary" onclick="clearFav()">–û—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
          <div class="btn danger" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</div>
        </div>

        <div style="margin-top:10px;color:var(--muted2)">
          –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è ‚Äî –ø—Ä–æ–≤–µ—Ä—å –≤ Supabase —Ç–∞–±–ª–∏—Ü—É <b>products</b> –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ <b>image_url</b>.
        </div>
      </div>
    </div>
  `;
}

/** =========================
 *  UI builders
 *  ========================= */
function productCard(p){
  const isFav = (state.fav || []).includes(p.id);
  const inCart = Number(state.cart?.[p.id] || 0);

  const img = p.image_url || "https://via.placeholder.com/600x600?text=NutriLab";
  const badge = p.category || "–ë–ê–î—ã";

  return `
    <div class="card">
      <div class="img">
        <img src="${escapeAttr(img)}" alt="${escapeAttr(p.name)}" onerror="this.src='https://via.placeholder.com/600x600?text=NutriLab';" />
        <div class="badge">${escapeHtml(badge)}</div>
        <div class="favbtn ${isFav?'active':''}" onclick="toggleFav('${escapeJs(p.id)}')">
          ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
        </div>
      </div>
      <div class="body">
        <div class="name">${escapeHtml(p.name)}</div>
        <div class="desc">${escapeHtml(trimText(p.description, 70))}</div>
        <div class="row">
          <div class="price">${formatPrice(p.price)} ‚ÇΩ</div>
          <div class="btn ${inCart>0?'secondary':''}" onclick="addToCart('${escapeJs(p.id)}')">
            ${inCart>0 ? `üõí +1 (${inCart})` : 'üõí –í –∫–æ—Ä–∑–∏–Ω—É'}
          </div>
        </div>
      </div>
    </div>
  `;
}

function cartItem(p, qty){
  const img = p.image_url || "https://via.placeholder.com/600x600?text=NutriLab";
  return `
    <div class="item">
      <div class="thumb">
        <img src="${escapeAttr(img)}" alt="${escapeAttr(p.name)}" onerror="this.src='https://via.placeholder.com/600x600?text=NutriLab';" />
      </div>
      <div class="it-b">
        <div class="it-t">
          <div class="it-name">${escapeHtml(p.name)}</div>
          <div class="it-price">${formatPrice(p.price * qty)} ‚ÇΩ</div>
        </div>
        <div class="qty">
          <div class="qbtn" onclick="decQty('${escapeJs(p.id)}')">‚àí</div>
          <div class="qnum">${qty}</div>
          <div class="qbtn" onclick="incQty('${escapeJs(p.id)}')">+</div>
          <div style="margin-left:auto;color:var(--muted);font-size:12px">${formatPrice(p.price)} ‚ÇΩ/—à—Ç</div>
        </div>
        <div class="it-actions">
          <span class="link" onclick="toggleFav('${escapeJs(p.id)}')">${(state.fav||[]).includes(p.id) ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}</span>
          <span class="link" style="color:rgba(224,82,82,.9)" onclick="removeFromCart('${escapeJs(p.id)}')">–£–¥–∞–ª–∏—Ç—å</span>
        </div>
      </div>
    </div>
  `;
}

/** =========================
 *  Logic: filter, fav, cart
 *  ========================= */
function getFilteredProducts(){
  const q = (state.q || "").toLowerCase();
  const cat = state.category || "–í—Å–µ";

  return (state.products || []).filter(p => {
    const okCat = (cat === "–í—Å–µ") ? true : (p.category === cat);
    const okQ = !q ? true : (
      (p.name || "").toLowerCase().includes(q) ||
      (p.description || "").toLowerCase().includes(q)
    );
    return okCat && okQ;
  });
}

function toggleFav(id){
  const fav = new Set(state.fav || []);
  if (fav.has(id)) {
    fav.delete(id);
    toast("–£–±—Ä–∞–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ");
  } else {
    fav.add(id);
    toast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ");
  }
  state.fav = Array.from(fav);
  saveState();
  render();
  updateBadges();
}

function clearFav(){
  state.fav = [];
  saveState();
  toast("–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –æ—á–∏—â–µ–Ω–æ");
  render();
  updateBadges();
}

function addToCart(id){
  const cur = Number(state.cart?.[id] || 0);
  state.cart = state.cart || {};
  state.cart[id] = cur + 1;
  saveState();
  toast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
  updateBadges();
  render();
}

function incQty(id){
  addToCart(id);
}
function decQty(id){
  const cur = Number(state.cart?.[id] || 0);
  if (cur <= 1) return removeFromCart(id);
  state.cart[id] = cur - 1;
  saveState();
  updateBadges();
  render();
}
function removeFromCart(id){
  if (!state.cart) return;
  delete state.cart[id];
  saveState();
  toast("–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã");
  updateBadges();
  render();
}
function clearCart(){
  state.cart = {};
  saveState();
  toast("–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞");
  updateBadges();
  render();
}

function updateBadges(){
  const favCount = (state.fav || []).length;
  const cartCount = Object.values(state.cart || {}).reduce((s,n)=>s+Number(n||0),0);

  const bf = document.getElementById("b-fav");
  const bc = document.getElementById("b-cart");

  if (favCount > 0) { bf.style.display="flex"; bf.textContent = String(favCount); }
  else { bf.style.display="none"; }

  if (cartCount > 0) { bc.style.display="flex"; bc.textContent = String(cartCount); }
  else { bc.style.display="none"; }
}

/** =========================
 *  Checkout -> Telegram
 *  ========================= */
function checkout(){
  const ids = Object.keys(state.cart || {});
  const lines = [];
  let total = 0;

  ids.forEach(id=>{
    const qty = Number(state.cart[id] || 0);
    if (qty <= 0) return;
    const p = state.products.find(x=>x.id===id);
    if (!p) return;
    const sum = p.price * qty;
    total += sum;
    lines.push(`‚Ä¢ ${p.name} √ó${qty} ‚Äî ${formatPrice(sum)} ‚ÇΩ`);
  });

  if (!lines.length){
    toast("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è");
    return;
  }

  const msg =
`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑:

${lines.join("\n")}

–ò—Ç–æ–≥–æ: ${formatPrice(total)} ‚ÇΩ

–§–ò–û:
–ì–æ—Ä–æ–¥:
–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏:`;

  openTelegramText(msg);
}

function openOrdersChat(){
  openTelegramText("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.");
}

function openTelegramText(text){
  const url = `https://t.me/${ORDER_USERNAME}?text=${encodeURIComponent(text)}`;
  // –ï—Å–ª–∏ —ç—Ç–æ Telegram WebApp ‚Äî –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
  window.open(url, "_blank");
}

/** =========================
 *  Helpers
 *  ========================= */
function toast(t){
  const el = document.getElementById("toast");
  el.textContent = t;
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.classList.remove("show"), 1400);
}

function formatPrice(n){
  const x = Number(n || 0);
  return x.toLocaleString("ru-RU");
}

function trimText(s, n){
  s = (s || "").toString().trim();
  if (!s) return "";
  return s.length > n ? s.slice(0, n-1) + "‚Ä¶" : s;
}

function saveState(){
  try{
    const safe = {
      view: state.view,
      q: state.q,
      category: state.category,
      fav: state.fav,
      cart: state.cart,
      products: state.products, // –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∫—ç—à, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–æ—Å—å
      loaded: state.loaded,
      lastError: state.lastError
    };
    localStorage.setItem(LS_KEY, JSON.stringify(safe));
  } catch(e){}
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch(e){
    return null;
  }
}

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("\n"," ");
}
function escapeJs(str){
  return (str ?? "").toString().replaceAll("\\","\\\\").replaceAll("'","\\'");
}

/** Telegram WebApp */
function tryInitTelegram(){
  try{
    const tg = window.Telegram?.WebApp;
    if (!tg) return;
    tg.ready();
    tg.expand();
  } catch(e){}
}
</script>

</body>
</html>
