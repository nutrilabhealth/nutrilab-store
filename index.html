<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NutriLab Health Store</title>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111c33;
      --muted:#93a4c7;
      --text:#eaf0ff;
      --accent:#22c55e;
      --accent2:#38bdf8;
      --danger:#ef4444;
      --border:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 50% -100px, #1b2a55 0%, var(--bg) 60%);
      color:var(--text);
      padding-bottom: 86px; /* –º–µ—Å—Ç–æ –ø–æ–¥ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    }
    a{color:inherit}
    .topbar{
      position: sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(15,23,42,.72);
      border-bottom:1px solid var(--border);
      padding: 14px 14px 10px;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:8px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      display:flex; gap:8px; align-items:center;
    }
    .searchRow{
      margin-top:10px;
      display:flex; gap:10px; align-items:center;
    }
    .search{
      flex:1;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
    }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .btnSmall{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .filters{
      margin-top:10px;
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom:6px;
    }
    .chip{
      white-space:nowrap;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
    }
    .chip.active{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.35);
    }

    .page{
      display:none;
      padding: 14px;
      max-width: 980px;
      margin: 0 auto;
    }
    .page.active{display:block}

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (min-width: 720px){
      .grid{grid-template-columns: repeat(3, minmax(0, 1fr))}
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: repeat(4, minmax(0, 1fr))}
    }
    .card{
      background: rgba(17,28,51,.72);
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      position:relative;
    }
    .imgWrap{
      aspect-ratio: 1/1;
      background: rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .imgWrap img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .cardBody{padding:10px 10px 12px}
    .title{
      font-weight:800;
      font-size:14px;
      line-height:1.2;
      margin:0 0 6px;
      min-height: 34px;
    }
    .meta{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      color:var(--muted);
      font-size:12px;
      margin-bottom:10px;
    }
    .price{
      font-size:16px;
      font-weight:900;
      color:var(--text);
    }
    .actions{
      display:flex; gap:8px;
    }
    .btn{
      flex:1;
      border:0;
      background: var(--accent);
      color:#06210f;
      font-weight:900;
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn.secondary{
      flex:0 0 auto;
      background: rgba(56,189,248,.18);
      color: var(--text);
      border:1px solid rgba(56,189,248,.35);
      font-weight:800;
    }
    .btn:active{transform:scale(.98); opacity:.9}

    .fav{
      position:absolute;
      top:10px; right:10px;
      width:36px; height:36px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      cursor:pointer;
      user-select:none;
    }
    .fav.active{
      background: rgba(239,68,68,.18);
      border-color: rgba(239,68,68,.35);
    }

    /* –°–ø–∏—Å–∫–∏: –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏ –∫–æ—Ä–∑–∏–Ω–∞ */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid var(--border);
      background: rgba(17,28,51,.55);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .rowImg{
      width:92px; height:92px;
      flex:0 0 auto;
      background: rgba(255,255,255,.04);
    }
    .rowImg img{width:100%;height:100%;object-fit:cover;display:block}
    .rowBody{padding:10px; flex:1}
    .rowTitle{margin:0 0 6px; font-weight:900}
    .rowSub{color:var(--muted); font-size:12px; margin-bottom:8px}
    .rowRight{padding:10px; display:flex; flex-direction:column; gap:8px; align-items:flex-end}
    .qty{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      border-radius: 999px;
      padding:6px 10px;
      background: rgba(255,255,255,.04);
    }
    .qty button{
      border:0;
      background:transparent;
      color:var(--text);
      font-size:16px;
      cursor:pointer;
      width:26px; height:26px;
      border-radius: 8px;
    }
    .qty span{min-width:18px; text-align:center; font-weight:900}
    .danger{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }

    .summary{
      margin-top:12px;
      border:1px solid var(--border);
      background: rgba(17,28,51,.6);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
    }
    .sumRow{display:flex; justify-content:space-between; color:var(--muted); margin:4px 0}
    .sumRow strong{color:var(--text)}
    .checkout{
      margin-top:10px;
      width:100%;
      background: var(--accent);
      color:#06210f;
      border:0;
      font-weight:900;
      padding:12px 14px;
      border-radius: 16px;
      cursor:pointer;
    }

    /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index:60;
      background: rgba(15,23,42,.85);
      border-top:1px solid var(--border);
      backdrop-filter: blur(12px);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .navInner{
      max-width: 980px;
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }
    .tab{
      border:1px solid transparent;
      background: rgba(255,255,255,.04);
      color:var(--muted);
      padding:10px 8px;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      user-select:none;
      font-size:11px;
      font-weight:800;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(56,189,248,.35);
      background: rgba(56,189,248,.14);
    }
    .badge{
      position:absolute;
      transform: translate(14px,-12px);
      background: var(--accent);
      color:#06210f;
      font-weight:1000;
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.2);
    }
    .tabIconWrap{position:relative}
    .empty{
      margin-top:10px;
      color:var(--muted);
      border:1px dashed var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding:14px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: 92px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid var(--border);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      display:none;
      z-index:80;
      backdrop-filter: blur(10px);
      max-width: calc(100% - 24px);
      text-align:center;
      font-weight:800;
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <h1>üöÄ NutriLab Health Store</h1>
      <div class="pill" id="statusPill">üü¢ online</div>
    </div>

    <div class="searchRow">
      <div class="search">
        üîé <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." />
      </div>
      <button class="btnSmall" id="sortBtn">‚áÖ</button>
    </div>

    <div class="filters" id="categoryChips"></div>
  </div>

  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section class="page active" id="page-home">
    <div class="grid" id="productGrid"></div>
  </section>

  <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
  <section class="page" id="page-fav">
    <h2 style="margin:6px 0 10px;">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
    <div class="list" id="favList"></div>
    <div class="empty" id="favEmpty" style="display:none;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ ‚ù§Ô∏è –Ω–∞ —Ç–æ–≤–∞—Ä–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>
  </section>

  <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
  <section class="page" id="page-cart">
    <h2 style="margin:6px 0 10px;">üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
    <div class="list" id="cartList"></div>
    <div class="empty" id="cartEmpty" style="display:none;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è. –î–æ–±–∞–≤—å —Ç–æ–≤–∞—Ä –Ω–∞ –ì–ª–∞–≤–Ω–æ–π.</div>

    <div class="summary" id="cartSummary" style="display:none;">
      <div class="sumRow"><span>–ü–æ–∑–∏—Ü–∏–π</span> <strong id="sumItems">0</strong></div>
      <div class="sumRow"><span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span> <strong id="sumQty">0</strong></div>
      <div class="sumRow"><span>–°—É–º–º–∞</span> <strong id="sumTotal">0 ‚ÇΩ</strong></div>
      <button class="checkout" id="checkoutBtn">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –≤ Telegram</button>
      <div style="color:var(--muted);font-size:12px;margin-top:8px;line-height:1.35;">
        –ù–∞–∂–º—ë—à—å ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è Telegram —Å –≥–æ—Ç–æ–≤—ã–º —Ç–µ–∫—Å—Ç–æ–º –∑–∞–∫–∞–∑–∞.
      </div>
    </div>
  </section>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <section class="page" id="page-profile">
    <h2 style="margin:6px 0 10px;">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
    <div class="summary">
      <div style="font-weight:900;margin-bottom:6px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="sumRow"><span>–ò–º—è –º–∞–≥–∞–∑–∏–Ω–∞</span> <strong>NutriLab</strong></div>
      <div class="sumRow"><span>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</span> <strong>Dark</strong></div>
      <div class="sumRow"><span>–•—Ä–∞–Ω–µ–Ω–∏–µ</span> <strong>localStorage</strong></div>
      <button class="danger" id="resetBtn" style="margin-top:10px;width:100%;">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
    </div>
    <div class="empty" style="margin-top:12px;">
      –•–æ—á–µ—à—å ‚Äî –¥–æ–±–∞–≤–∏–º —Å—é–¥–∞ ‚Äú–ö–æ–Ω—Ç–∞–∫—Ç—ã‚Äù, ‚Äú–î–æ—Å—Ç–∞–≤–∫–∞‚Äù, ‚Äú–û–ø–ª–∞—Ç–∞‚Äù, ‚Äú–ü–æ–¥–¥–µ—Ä–∂–∫–∞‚Äù.
    </div>
  </section>

  <!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
  <nav class="nav">
    <div class="navInner">
      <div class="tab active" data-tab="home">
        <div class="tabIconWrap">üè†</div>
        –ì–ª–∞–≤–Ω–∞—è
      </div>
      <div class="tab" data-tab="fav">
        <div class="tabIconWrap">‚ù§Ô∏è</div>
        –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
      </div>
      <div class="tab" data-tab="cart">
        <div class="tabIconWrap">
          üõí <span class="badge" id="cartBadge" style="display:none;">0</span>
        </div>
        –ö–æ—Ä–∑–∏–Ω–∞
      </div>
      <div class="tab" data-tab="profile">
        <div class="tabIconWrap">üë§</div>
        –ü—Ä–æ—Ñ–∏–ª—å
      </div>
    </div>
  </nav>

  <div class="toast" id="toast"></div>

  <script>
    // =====================
    // –ù–ê–°–¢–†–û–ô–ö–ê: –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑
    // –í–∞—Ä–∏–∞–Ω—Ç A: –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
    // –í—Å—Ç–∞–≤—å —Å–≤–æ–π username –ë–ï–ó @
    // =====================
    const ORDER_USERNAME = "nutrilabhealth"; // <-- –æ—Å—Ç–∞–≤—å —Å–≤–æ–π

    // =====================
    // –¢–æ–≤–∞—Ä—ã (–¥–æ–±–∞–≤–ª—è—Ç—å –ª–µ–≥–∫–æ)
    // image: –º–æ–∂–Ω–æ "./–∏–º—è_—Ñ–∞–π–ª–∞.png" –µ—Å–ª–∏ –ª–µ–∂–∏—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ä—è–¥–æ–º —Å index.html
    // =====================
    const PRODUCTS = [
      {
        id: "omega3",
        name: "Nordic Bork Omega-3",
        price: 2900,
        category: "–í–∏—Ç–∞–º–∏–Ω—ã",
        image: "./81240CBA-CD5A-4E5D-950A-BDE745990748.png"
      },
      // –¥–æ–±–∞–≤–∏—à—å –≤—Ç–æ—Ä–æ–π ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π –±–ª–æ–∫
      // {
      //   id:"creatine",
      //   name:"Creatine Monohydrate 300g",
      //   price:1700,
      //   category:"–ü—Ä–æ—Ç–µ–∏–Ω—ã",
      //   image:"./creatine.png"
      // }
    ];

    // =====================
    // Storage
    // =====================
    const LS_CART = "nl_cart_v1";
    const LS_FAV  = "nl_fav_v1";

    const state = {
      cart: loadJSON(LS_CART, {}), // { productId: qty }
      fav:  new Set(loadJSON(LS_FAV, [])), // Set(productId)
      category: "–í—Å–µ",
      q: "",
      sort: "default" // default | price_asc | price_desc
    };

    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch(e){
        return fallback;
      }
    }
    function save(){
      localStorage.setItem(LS_CART, JSON.stringify(state.cart));
      localStorage.setItem(LS_FAV, JSON.stringify(Array.from(state.fav)));
      updateBadges();
    }

    // =====================
    // UI helpers
    // =====================
    const $ = (id)=>document.getElementById(id);
    function rub(n){
      return new Intl.NumberFormat("ru-RU").format(n) + " ‚ÇΩ";
    }
    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.style.display="none", 1600);
    }

    // =====================
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–∞–±—ã)
    // =====================
    const pages = {
      home: $("page-home"),
      fav: $("page-fav"),
      cart: $("page-cart"),
      profile: $("page-profile")
    };
    document.querySelectorAll(".tab").forEach(tab=>{
      tab.addEventListener("click", ()=>{
        const name = tab.dataset.tab;
        showPage(name);
      });
    });

    function showPage(name){
      Object.values(pages).forEach(p=>p.classList.remove("active"));
      pages[name].classList.add("active");

      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelector(`.tab[data-tab="${name}"]`).classList.add("active");

      // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –Ω—É–∂–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
      if(name==="home") renderHome();
      if(name==="fav") renderFav();
      if(name==="cart") renderCart();
    }

    // =====================
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    // =====================
    function renderCategories(){
      const cats = ["–í—Å–µ", ...Array.from(new Set(PRODUCTS.map(p=>p.category)))];
      const wrap = $("categoryChips");
      wrap.innerHTML = "";
      cats.forEach(c=>{
        const b = document.createElement("button");
        b.className = "chip" + (state.category===c ? " active" : "");
        b.textContent = c;
        b.onclick = ()=>{
          state.category = c;
          renderCategories();
          renderHome();
        };
        wrap.appendChild(b);
      });
    }

    // =====================
    // –ü–æ–∏—Å–∫ / —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    // =====================
    $("searchInput").addEventListener("input", (e)=>{
      state.q = e.target.value.trim().toLowerCase();
      renderHome();
    });

    $("sortBtn").addEventListener("click", ()=>{
      if(state.sort==="default") state.sort="price_asc";
      else if(state.sort==="price_asc") state.sort="price_desc";
      else state.sort="default";
      toast(state.sort==="default" ? "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" :
            state.sort==="price_asc" ? "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Ü–µ–Ω–∞ ‚Üë" : "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Ü–µ–Ω–∞ ‚Üì");
      renderHome();
    });

    // =====================
    // –ì–ª–∞–≤–Ω–∞—è: —Ç–æ–≤–∞—Ä—ã
    // =====================
    function getVisibleProducts(){
      let list = PRODUCTS.slice();

      if(state.category!=="–í—Å–µ"){
        list = list.filter(p=>p.category===state.category);
      }
      if(state.q){
        list = list.filter(p => p.name.toLowerCase().includes(state.q));
      }

      if(state.sort==="price_asc"){
        list.sort((a,b)=>a.price-b.price);
      }else if(state.sort==="price_desc"){
        list.sort((a,b)=>b.price-a.price);
      }
      return list;
    }

    function renderHome(){
      const grid = $("productGrid");
      const list = getVisibleProducts();
      grid.innerHTML = "";

      list.forEach(p=>{
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="fav ${state.fav.has(p.id) ? "active" : ""}" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">‚ù§Ô∏è</div>
          <div class="imgWrap">
            <img src="${p.image}" alt="${escapeHtml(p.name)}" loading="lazy" />
          </div>
          <div class="cardBody">
            <p class="title">${escapeHtml(p.name)}</p>
            <div class="meta">
              <span>${escapeHtml(p.category)}</span>
              <span class="price">${rub(p.price)}</span>
            </div>
            <div class="actions">
              <button class="btn" data-add="${p.id}">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button>
              <button class="btn secondary" data-buy="${p.id}">‚úÖ –ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        `;

        // fav toggle
        card.querySelector(".fav").onclick = ()=>{
          if(state.fav.has(p.id)){
            state.fav.delete(p.id);
            toast("–£–±—Ä–∞–ª–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ");
          }else{
            state.fav.add(p.id);
            toast("–î–æ–±–∞–≤–∏–ª–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ");
          }
          save();
          renderHome();
        };

        // add cart
        card.querySelector(`[data-add="${p.id}"]`).onclick = ()=>{
          state.cart[p.id] = (state.cart[p.id] || 0) + 1;
          save();
          toast("–î–æ–±–∞–≤–∏–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É");
        };

        // buy now (1 —Ç–æ–≤–∞—Ä) -> telegram
        card.querySelector(`[data-buy="${p.id}"]`).onclick = ()=>{
          const msg = makeSingleOrderText(p);
          openTelegram(msg);
        };

        grid.appendChild(card);
      });

      if(list.length===0){
        grid.innerHTML = `<div class="empty" style="grid-column:1/-1;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>`;
      }

      updateBadges();
    }

    // =====================
    // –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
    // =====================
    function renderFav(){
      const listEl = $("favList");
      const emptyEl = $("favEmpty");

      const favProducts = PRODUCTS.filter(p=>state.fav.has(p.id));
      listEl.innerHTML = "";

      if(favProducts.length===0){
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      favProducts.forEach(p=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="rowImg"><img src="${p.image}" alt="${escapeHtml(p.name)}" /></div>
          <div class="rowBody">
            <p class="rowTitle">${escapeHtml(p.name)}</p>
            <div class="rowSub">${escapeHtml(p.category)} ‚Ä¢ <b>${rub(p.price)}</b></div>
            <div style="display:flex; gap:8px;">
              <button class="btn" style="flex:0 0 auto;" data-add="${p.id}">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button>
              <button class="danger" data-del="${p.id}">–£–¥–∞–ª–∏—Ç—å ‚ù§Ô∏è</button>
            </div>
          </div>
        `;
        row.querySelector(`[data-add="${p.id}"]`).onclick = ()=>{
          state.cart[p.id] = (state.cart[p.id] || 0) + 1;
          save();
          toast("–î–æ–±–∞–≤–∏–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É");
        };
        row.querySelector(`[data-del="${p.id}"]`).onclick = ()=>{
          state.fav.delete(p.id);
          save();
          renderFav();
          toast("–£–¥–∞–ª–∏–ª–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ");
        };
        listEl.appendChild(row);
      });
    }

    // =====================
    // –ö–æ—Ä–∑–∏–Ω–∞
    // =====================
    function renderCart(){
      const listEl = $("cartList");
      const emptyEl = $("cartEmpty");
      const sumEl = $("cartSummary");

      const entries = Object.entries(state.cart).filter(([id,qty])=>qty>0);
      listEl.innerHTML = "";

      if(entries.length===0){
        emptyEl.style.display = "block";
        sumEl.style.display = "none";
        updateBadges();
        return;
      }

      emptyEl.style.display = "none";
      sumEl.style.display = "block";

      let itemsCount = 0;
      let totalQty = 0;
      let totalSum = 0;

      entries.forEach(([id, qty])=>{
        const p = PRODUCTS.find(x=>x.id===id);
        if(!p) return;

        itemsCount += 1;
        totalQty += qty;
        totalSum += p.price * qty;

        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="rowImg"><img src="${p.image}" alt="${escapeHtml(p.name)}"/></div>
          <div class="rowBody">
            <p class="rowTitle">${escapeHtml(p.name)}</p>
            <div class="rowSub"><b>${rub(p.price)}</b> ‚Ä¢ ${escapeHtml(p.category)}</div>
            <div style="color:var(--muted);font-size:12px;">–ò—Ç–æ–≥–æ: <b style="color:var(--text)">${rub(p.price*qty)}</b></div>
          </div>
          <div class="rowRight">
            <div class="qty">
              <button data-minus="${id}">‚àí</button>
              <span>${qty}</span>
              <button data-plus="${id}">+</button>
            </div>
            <button class="danger" data-remove="${id}">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;

        row.querySelector(`[data-minus="${id}"]`).onclick = ()=>{
          state.cart[id] = Math.max(0, (state.cart[id]||0) - 1);
          if(state.cart[id]===0) delete state.cart[id];
          save();
          renderCart();
        };
        row.querySelector(`[data-plus="${id}"]`).onclick = ()=>{
          state.cart[id] = (state.cart[id]||0) + 1;
          save();
          renderCart();
        };
        row.querySelector(`[data-remove="${id}"]`).onclick = ()=>{
          delete state.cart[id];
          save();
          renderCart();
          toast("–£–¥–∞–ª–∏–ª–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã");
        };

        listEl.appendChild(row);
      });

      $("sumItems").textContent = itemsCount;
      $("sumQty").textContent = totalQty;
      $("sumTotal").textContent = rub(totalSum);

      $("checkoutBtn").onclick = ()=>{
        const msg = makeCartOrderText();
        openTelegram(msg);
      };

      updateBadges();
    }

    function updateBadges(){
      const qty = Object.values(state.cart).reduce((a,b)=>a+(b||0),0);
      const badge = $("cartBadge");
      if(qty>0){
        badge.style.display = "inline-block";
        badge.textContent = qty;
      }else{
        badge.style.display = "none";
      }
    }

    // =====================
    // –ó–∞–∫–∞–∑ –≤ Telegram (–≤ –ª–∏—á–∫—É)
    // =====================
    function openTelegram(message){
      const text = encodeURIComponent(message);
      // –í–∞–∂–Ω–æ: —É t.me/<user>?text=... –∑–Ω–∞–∫ "?" –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
      const url = `https://t.me/${ORDER_USERNAME}?text=${text}`;
      window.location.href = url;
    }

    function makeSingleOrderText(p){
      return `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å:\n\n‚Ä¢ ${p.name}\n‚Ä¢ –¶–µ–Ω–∞: ${p.price} ‚ÇΩ\n\n–ú–æ–π –∫–æ–Ω—Ç–∞–∫—Ç: (—É–∫–∞–∂—É –∑–¥–µ—Å—å)\n–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: (—É–∫–∞–∂—É –∑–¥–µ—Å—å)`;
    }

    function makeCartOrderText(){
      const entries = Object.entries(state.cart).filter(([id,qty])=>qty>0);
      let lines = [];
      let total = 0;

      for(const [id, qty] of entries){
        const p = PRODUCTS.find(x=>x.id===id);
        if(!p) continue;
        total += p.price * qty;
        lines.push(`‚Ä¢ ${p.name} √ó${qty} = ${p.price*qty} ‚ÇΩ`);
      }

      return `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑:\n\n${lines.join("\n")}\n\n–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ\n\n–ú–æ–π –∫–æ–Ω—Ç–∞–∫—Ç: (—É–∫–∞–∂—É –∑–¥–µ—Å—å)\n–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: (—É–∫–∞–∂—É –∑–¥–µ—Å—å)`;
    }

    // =====================
    // –ü—Ä–æ—Ñ–∏–ª—å: –æ—á–∏—Å—Ç–∫–∞
    // =====================
    $("resetBtn").onclick = ()=>{
      if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ?")){
        state.cart = {};
        state.fav = new Set();
        save();
        renderHome();
        renderFav();
        renderCart();
        toast("–û—á–∏—Å—Ç–∏–ª–∏");
      }
    };

    // =====================
    // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
    // =====================
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // init
    renderCategories();
    renderHome();
    updateBadges();
  </script>
</body>
</html>
